# --- 1. SETUP & PARAMETERS ---

```{r}
# Load required libraries
library(dplyr)
library(mgcv)
library(gamm4)
library(ggplot2)
library(glue)
library(tidyr)
library(purrr)
library(lubridate)
library(zoo)
library(marginaleffects)
  
# Set random seed for reproducibility
set.seed(
 123
)

```


# Load the data file
```{r}
load("~/CLEAR Lab Repositories/adhd-cycle/data/adhd_daily_scaled_20250929.rdata") # Enter the file path for your data file; note that it must include pacts_scaling() output and there must be 5 observations per phase per person to include.
```

# Define the base folder for all outputs
```{r}
output_folder_base <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output"
smm_output_folder <- file.path(output_folder_base, "3_smm_output") # Simplified folder name
if (!dir.exists(smm_output_folder)) {
  dir.create(smm_output_folder, recursive = TRUE)
}
```

# Choose your time variables
```{r}
menses_time_variable <- "cyclic_time_impute"
ovulation_time_variable <- "cyclic_time_imp_ov"
```


# <-- 1. Your complete list of outcomes is defined here.
# Names = technical variable names in the dataframe
# Values = pretty labels for plots
```{r}
source("~/CLEAR Lab Repositories/adhd-cycle/0_setup_scripts/outcomes_list.R")
```



# --- 2. AUTOMATED ANALYSIS LOOP ---

```{r}
# Source function files
source("~/CLEAR Lab Repositories/code_templates/3_model/smm/preprocess_outcome.R")
source("~/CLEAR Lab Repositories/code_templates/3_model/smm/subset_by_phase_cyclic.R")
source("~/CLEAR Lab Repositories/code_templates/3_model/smm/run_smm_cyclic.R")
source("~/CLEAR Lab Repositories/code_templates/3_model/smm/model_plot_gam_cyclic.R")
source("~/CLEAR Lab Repositories/code_templates/3_model/smm/compare_bic_cyclic.R")

```

```{r}
# --- AUTOMATED ANALYSIS LOOP ---
analysis_combinations <- expand.grid(
  outcome = names(outcomes),
  centering = c("menses", "ovulation"),
  stringsAsFactors = FALSE
)

all_smm_results <- list()
all_bic_results <- list()
all_gam_results <- list()

for (i in 1:nrow(analysis_combinations)) {
  current_outcome <- analysis_combinations$outcome[i]
  current_centering <- analysis_combinations$centering[i]
  current_plot_label <- outcomes[current_outcome]
  current_time_var <- ifelse(current_centering == "menses", menses_time_variable, ovulation_time_variable)

  message(paste0("\n🚀 Starting analysis for: '", current_plot_label, "' (", current_centering, "-centered)"))

  preprocessed_data <- preprocess_outcome(data = cycle_df_scaled, outcome = current_outcome)

  subset_result <- subset_by_phase_cyclic(
    data = preprocessed_data,
    outcome = current_outcome,
    time_var = current_time_var,
    min_obs = 4
  )
  data_for_analysis <- subset_result$data_subset

  if (nrow(data_for_analysis) < 15) {
      message(paste0("⚠️ Skipping '", current_plot_label, "' due to insufficient data after subsetting."))
      next
  }

  smm_results <- run_smm_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var,
    plot_label = current_plot_label,
    g = 2:4,
    centering = current_centering,
    save_dir = smm_output_folder
  )

  list_name <- paste0(current_outcome, "_", current_centering)
  all_smm_results[[list_name]] <- smm_results

  # --- ‼️ ADDED THIS BLOCK BACK IN TO GENERATE THE BIC PLOT ‼️ ---
  if (!is.null(smm_results) && length(smm_results$all_results) > 0) {
    bic_result <- compare_bic_cyclic(
      data = data_for_analysis,
      outcome = current_outcome,
      time_var = current_time_var,
      centering = current_centering,
      smm_results = smm_results,
      save_dir = smm_output_folder
    )
    all_bic_results[[list_name]] <- bic_result
  # --- END OF FIX ---

    gams <- model_plot_modx_gam_cyclic(
      data = data_for_analysis,
      outcome = current_outcome,
      time_var = current_time_var,
      smm_result = smm_results,
      plot_label = current_plot_label,
      centering = current_centering,
      save_dir = smm_output_folder
    )
    all_gam_results[[list_name]] <- gams
  }

  message(paste0("✅ Finished analysis for: '", current_plot_label, "' (", current_centering, "-centered)"))
}

message("\n🏁 ALL OUTCOMES PROCESSED! 🏁")
```

