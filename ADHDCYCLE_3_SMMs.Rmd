---
title: "CYCLE ADHD R01 - Flexible Automated Cyclic SMM Analysis"
author: "Tory Eisenlohr-Moul"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# --- 1. SETUP: LOAD LIBRARIES AND FUNCTIONS ---
library(dplyr)
library(tidyverse)
library(mgcv)
library(gamm4)
library(ggplot2)
library(zoo)
library(glue)
library(slider)


# Load all the custom functions from their R files
source("~/CLEAR Lab Repositories/proj_BEARS/scripts/compare_bic_cyclic.R")
source("~/CLEAR Lab Repositories/proj_BEARS/scripts/model_plot_modx_gam_cyclic.R")
source("~/CLEAR Lab Repositories/proj_BEARS/scripts/run_smm_cyclic.R")
source("~/CLEAR Lab Repositories/proj_BEARS/scripts/subset_by_phase_cyclic.R")

```


# 0. Input scaled R daily data file saved from prep file

```{r}

# Define the file path
file_path <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2025-09-27_Interim_Datasets/adhd_daily_scaled_20250927.RData"

# Load the .RData file. This will restore the object with its original name, 'df_scaled'.
load(file_path)

cycle_df_scaled <- df_scaled
```



  

# --- 1. Setup ---

```{r}

# Assume 'cycle_df_scaled' is your pre-existing dataframe

# --- Output Folder ---
output_folder_base <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output"

smm_output_folder <- file.path(output_folder_base, format(Sys.Date(), "%Y-%m-%d_SMMs/"))

if (!dir.exists(smm_output_folder)) {
  dir.create(smm_output_folder, recursive = TRUE)
}


current_date <- format(Sys.Date(), "%Y%m%d")

# Create the full output file name with the date
file_name <- paste0("SMM_", current_date, ".rds")
full_path <- paste0(smm_output_folder, file_name)

if (!dir.exists(smm_output_folder)) {
  dir.create(smm_output_folder, recursive = TRUE)
}

# Example of how you would save your data using the full path
# saveRDS(cycle_df_scaled, file = full_path)

```

# --- 2. Define Outcomes and Their Plot Labels ---
 "CSS_Inatt" = "CSS Inattention Sx Severity",
  "CSS_HypImp" = "CSS Hyperactivity/Impulsivity Sx Severity",
  "CSS_Inatt_Count" = "CSS Inattention Sx Count",
  "CSS_Hyp_Count" = "CSS Hyperactivity Sx Count", 
  "CSS_Imp_Count" = "CSS Impulsivity Sx Count", 
    "score_pinball" = "Working Memory Score (Pinball)", 
    "score_robot" = "Reponse Inhibition (Robot Factory)", 
    "BDEFS_WM_avg" = "Working Memory Sx (BDEFS)", 
    "BDEFS_RI_avg" = "Response Inhibition Sx (BDEFS)", 
    "DRSP_1" = "Depressed Mood", 
  "DRSP_2" = "Hopelessness",
    "DRSP_3" = "Worthlessness/Guilt",
    "DRSP_4" = "Anxiety", 
  "DRSP_5" = "Mood Swings",
  "DRSP_6" = "Rejection Sensitivity",
    "DRSP_7" = "Irritability",
  "DRSP_8" = "Interpersonal Conflicts",
  "DRSP_9" = "Less Interest in Activities",
  "DRSP_10" = "Difficulty Concentrating",
  "DRSP_11" = "Lethargy/Fatigue",
  "DRSP_12" = "Increased Appetite/Overate",
  "DRSP_13" = "Food Cravings",
  "DRSP_14" = "Hypersomnia",
  "DRSP_15" = "Insomnia",
  "DRSP_16" = "Overwhelmed/Couldn't Cope",
  "DRSP_17" = "Felt Out of Control",
    "DRSP_18" = "Breast Tenderness",
    "DRSP_19" = "Swelling/Bloating",
  "DRSP_20" = "Headache",
  "DRSP_21" = "Joint/Muscle Pain",
  "DRSP_22" = "Work Impairment",
  "DRSP_23" = "Relationship Impairment", # Note that hobbies/social was removed
  "E2" = "Estradiol",
  "P4" = "Progesterone",
  "LH" = "Luteinizing Hormone", 
  "UPPS_NU_avg" = "UPPS Negative Urgency",
  "UPPS_PU_avg" = "UPPS Positive Urgency",
  "UPPS_Premed_avg" = "UPPS (Lack of) Premeditation",
  "UPPS_Persev_avg" = "UPPS (Lack of) Perseverance",
  "UPPS_Sens_avg" = "UPPS Sensation Seeking",
  "DEBQ_Total = "DEBQ Total Score")


```{r}

# This named vector uses your short variable names.
# NAMES = the column names in your dataframe (e.g., dep)
# VALUES = the pretty labels for your plots (e.g., "Depressed Mood")
outcomes <- c(  "UPPS_NU_avg" = "UPPS Negative Urgency",
  "UPPS_PU_avg" = "UPPS Positive Urgency",
  "UPPS_Premed_avg" = "UPPS (Lack of) Premeditation",
  "UPPS_Persev_avg" = "UPPS (Lack of) Perseverance",
  "UPPS_Sens_avg" = "UPPS Sensation Seeking",
  "DEBQ_Total" = "DEBQ Total Score")

 View(cycle_df_scaled)             
# --- 3. Verify that Outcome Variables Exist in the Dataframe ---
# This loop checks that all the columns defined above are actually in your dataframe.

# Get the column names from your dataframe (replace with your actual df name)
actual_colnames <- names(cycle_df_scaled)

# Loop through your defined outcomes and check if they exist
message("--- Checking for outcome variables in the dataframe ---")
for (outcome_variable in names(outcomes)) {
  if (outcome_variable %in% actual_colnames) {
    message(paste("✅ Found:", outcome_variable))
  } else {
    message(paste("❌ NOT FOUND:", outcome_variable, " - Check your dataframe and variable names!"))
  }
}

```



```{r}
# --- 2. DEFINE ANALYSIS PARAMETERS ---

#View(cycle_df_scaled)

# --- ‼️ CHOOSE YOUR TIME VARIABLES HERE ‼️ ---
# Set the exact variable name for menses-centered analysis
menses_time_variable <- "cyclic_time_impute"  # Or "cyclic_time"

# Set the exact variable name for ovulation-centered analysis
ovulation_time_variable <- "cyclic_time_imp_ov"  # Or "cyclic_time_ov"

cycle_df_scaled$cyclic_time_imp_ov
centering_methods <- c("menses", "ovulation")

```



```{r}

# --- 3. HELPER FUNCTION ---
preprocess_outcome <- function(data, outcome) {
  outcome_log <- paste0(outcome, "_log")
  outcome_log_d <- paste0(outcome, "_log.d")
  outcome_roll <- paste0(outcome, "_log.d.roll")
  
  data %>%
    mutate(id = as.factor(id)) %>%
    mutate(!!outcome_log := log(.data[[outcome]] + 1)) %>%
    group_by(id) %>%
    mutate(!!outcome_log_d := .data[[outcome_log]] - mean(.data[[outcome_log]], na.rm = TRUE)) %>%
    mutate(!!outcome_roll := slider::slide_dbl(
      .x = .data[[outcome_log_d]],
      .f = mean,
      .before = 2,
      .after = 2,
      .partial = TRUE,
      .na_rm = TRUE
    )) %>%
    ungroup()
}

```

```{r}
# --- 4. AUTOMATED ANALYSIS LOOP ---
analysis_combinations <- expand.grid(
  outcome = names(outcomes),
  centering = centering_methods,
  stringsAsFactors = FALSE
)

all_smm_results <- list()
all_bic_results <- list()                                                              
all_gam_results <- list()

for (i in 1:nrow(analysis_combinations)) {
  current_outcome <- analysis_combinations$outcome[i]
  current_centering <- analysis_combinations$centering[i]
  
  # Determine the time variable name based on your choice above
  current_time_var <- ifelse(current_centering == "menses", menses_time_variable, ovulation_time_variable)
  
  message(paste0("\n🚀 Starting analysis for outcome: ", current_outcome, " (", current_centering, "-centered using '", current_time_var, "')"))
  
  preprocessed_data <- preprocess_outcome(data = cycle_df_scaled, outcome = current_outcome)
  
  subset_result <- subset_by_phase_cyclic(
    data = preprocessed_data,
    outcome = current_outcome,
    time_var = current_time_var,
    min_obs = 3
  )
  data_for_analysis <- subset_result$data_subset
  
  smm_results <- run_smm_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var, # Pass the chosen time variable
    g = 2:4,
    d_inter = 20,
    k_smooth = 10,
    plot = TRUE,
    centering = current_centering,
    save_dir = smm_output_folder
  )
  
  list_name <- paste0(current_outcome, "_", current_centering)
  all_smm_results[[list_name]] <- smm_results
  
  bic_result <- compare_bic_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var, # Pass the chosen time variable
    centering = current_centering,
    smm_results = smm_results,
    save_dir = smm_output_folder
  )
  
  all_bic_results[[list_name]] <- bic_result
  
  gams <- model_plot_modx_gam_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var, # Pass the chosen time variable
    smm_result = smm_results,
    centering = current_centering,
    save_dir = smm_output_folder,
    k_smooth = 10
  )
  
  all_gam_results[[list_name]] <- gams
  
  message(paste0("✅ Finished analysis for outcome: ", current_outcome, " (", current_centering, "-centered)"))
}

message("\n🏁 ALL OUTCOMES PROCESSED! 🏁")
```



```{r}
# --- 2. DEFINE ANALYSIS PARAMETERS ---

#View(cycle_df_scaled)

# --- ‼️ CHOOSE YOUR TIME VARIABLES HERE ‼️ ---
# Set the exact variable name for menses-centered analysis
menses_time_variable <- "cyclic_time"  # Or "cyclic_time_impute"

# Set the exact variable name for ovulation-centered analysis
ovulation_time_variable <- "cyclic_time_ov"  # Or "cyclic_time_ov_imp"

centering_methods <- c("menses", "ovulation")

```


```{r}
# --- 4. AUTOMATED ANALYSIS LOOP ---
analysis_combinations <- expand.grid(
  outcome = names(outcomes),
  centering = centering_methods,
  stringsAsFactors = FALSE
)

all_smm_results <- list()
all_bic_results <- list()                                                              
all_gam_results <- list()

for (i in 1:nrow(analysis_combinations)) {
  current_outcome <- analysis_combinations$outcome[i]
  current_centering <- analysis_combinations$centering[i]
  
  # Determine the time variable name based on your choice above
  current_time_var <- ifelse(current_centering == "menses", menses_time_variable, ovulation_time_variable)
  
  message(paste0("\n🚀 Starting analysis for outcome: ", current_outcome, " (", current_centering, "-centered using '", current_time_var, "')"))
  
  preprocessed_data <- preprocess_outcome(data = cycle_df_scaled, outcome = current_outcome)
  
  subset_result <- subset_by_phase_cyclic(
    data = preprocessed_data,
    outcome = current_outcome,
    time_var = current_time_var,
    min_obs = 5
  )
  data_for_analysis <- subset_result$data_subset
  
  smm_results <- run_smm_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var, # Pass the chosen time variable
    g = 2:5,
    d_inter = 20,
    k_smooth = 10,
    plot = TRUE,
    centering = current_centering,
    save_dir = smm_output_folder
  )
  
  list_name <- paste0(current_outcome, "_", current_centering)
  all_smm_results[[list_name]] <- smm_results
  
  bic_result <- compare_bic_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var, # Pass the chosen time variable
    centering = current_centering,
    smm_results = smm_results,
    save_dir = smm_output_folder
  )
  
  all_bic_results[[list_name]] <- bic_result
  
  gams <- model_plot_modx_gam_cyclic(
    data = data_for_analysis,
    outcome = current_outcome,
    time_var = current_time_var, # Pass the chosen time variable
    smm_result = smm_results,
    centering = current_centering,
    save_dir = smm_output_folder,
    k_smooth = 10
  )
  
  all_gam_results[[list_name]] <- gams
  
  message(paste0("✅ Finished analysis for outcome: ", current_outcome, " (", current_centering, "-centered)"))
}

message("\n🏁 ALL OUTCOMES PROCESSED! 🏁")
```









