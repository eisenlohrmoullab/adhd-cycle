---
title: "CYCLE ADHD R01 - Figure Compilation"
author: "Tory Eisenlohr-Moul"
date: "`r Sys.Date()`"
output: html_document
---
# --- 1. SETUP: LOAD LIBRARIES AND FUNCTIONS ---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(dplyr)
library(tidyverse)
library(mgcv)
library(gamm4)
library(ggplot2)
library(zoo)
library(glue)
library(slider)
library(cowplot)
library(ggplot2)
library(stringr)
library(tools)
library(ggplot2)
library(png)
library(grid)
library(cowplot)

```


```{r}
#Load final copy of cleaned dataset df_scaled rdata from the folder here to /data:  /Users/toryeisenlohr-moul/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/interim_datasets/adhd_daily_scaled_20250927.rdata

#load("/Users/toryeisenlohr-moul/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/interim_datasets/adhd_daily_scaled_20250927.rdata")

#cycle_df_scaled <- df_scaled
#rm(df_scaled)

# Save a copy of cycle_df_scaled as an rdata file to /data in the repo
#save(cycle_df_scaled, file = "~/CLEAR Lab Repositories/adhd-cycle/data/cycle_df_scaled_20250927.rdata")

# set wd to repo
setwd("~/CLEAR Lab Repositories/adhd-cycle")

# load a copy of cycle_df_scaled from /data in the repo
load("~/CLEAR Lab Repositories/adhd-cycle/data/cycle_df_scaled_20250927.rdata")

```

# Make Figure 1. ICCs, Between- and Within-Person Associations of Study Variables

```{r corrheatmap, echo=TRUE, message=FALSE, warning=FALSE, fig.width=9, fig.height=6}
# ===================================================================
# Script: correlation_heatmap_runner.R
# Purpose: Generate and save a multilevel correlation heatmap 
#          for selected outcome variables.
# Author: Tory E-M (CLEAR Lab)
# ===================================================================

# -------------------------------------------------------------------
# 1. Source the correlation heatmap function
# -------------------------------------------------------------------
source("~/CLEAR Lab Repositories/adhd-cycle/scripts/corrplots_fx.R")

# -------------------------------------------------------------------
# 2. Define output directory for saving figures
# -------------------------------------------------------------------
# Make sure this folder exists and is writeable
output_folder <- "~/CLEAR Lab Repositories/adhd-cycle/outputs/"

# -------------------------------------------------------------------
# 3. Specify outcome variables for correlation heatmap
# -------------------------------------------------------------------
corrplotlist <- c(
  "CSS_Inatt", "CSS_HypImp", "E2.3roll", "P4.3roll", "LH.3roll",
  "BDEFS_WM_avg", "BDEFS_RI_avg",
  "score_pinball", "score_robot",
  "DRSP_1", "DRSP_4", "DRSP_6", "DRSP_7", "DRSP_21"
)

# -------------------------------------------------------------------
# 4. Check that required objects exist and generate heatmap
# -------------------------------------------------------------------
if (exists("cycle_df_scaled") && exists("corrplotlist")) {
  
  # Generate correlation heatmap from the scaled dataset
  correlation_heatmap <- generate_correlation_heatmap(
    data = cycle_df_scaled,
    outcome_vars = corrplotlist,
    id_var = "id"
  )
  
  # Print the heatmap to the RStudio plots pane
  print(correlation_heatmap)
  
  # Save the heatmap to a high-resolution PNG file
  ggsave(
    filename = file.path(output_folder, "multilevel_correlation_heatmap.png"),
    plot = correlation_heatmap,
    width = 12, height = 11, dpi = 300
  )
  
} else {
  # Warn if required objects are missing
  warning("Data 'cycle_df_scaled' or 'corrplotlist' not found. Cannot generate heatmap.")
}
```


# Make Figure 2 - Gather .png figures from a specific folder location and compile them into a publication-ready graph with specified order
```{r}
# Define the directory containing the figures
figure_directory <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2025-09-27_GAMMs/cyclic_time_impute/plots/sxgammfig"

# List all PNG files in the directory
png_files <- list.files(figure_directory, pattern = "\\.png$", full.names = TRUE)

# Print just the text filenames without the full path
print(basename(png_files))

```

```{r}
# --------------------------------------------------------------------------
# NEW: Define the desired order of your plot filenames
# --------------------------------------------------------------------------
# List the base filenames (e.g., "my_plot.png") in the exact order
# you want them to appear in the grid (top-left, top-right, middle-left, etc.).
plot_order <- c(
  "gamplot_CSS_Inatt_Log_cyclic_time_impute_20250927.png", "gamplot_CSS_HypImp_Log_cyclic_time_impute_20250927.png", 
  "gamplot_score_pinball_Log_cyclic_time_impute_20250927.png", "gamplot_score_robot_Log_cyclic_time_impute_20250927.png"
 ) 

# Create the full file paths based on your specified order
png_files <- file.path(figure_directory, plot_order)
# --------------------------------------------------------------------------


# Load each PNG file as a ggplot object
# This now loads the files in the order you defined above
plots <- lapply(png_files, function(file) {
  img <- png::readPNG(file)
  ggplot() +
    annotation_custom(rasterGrob(img, width = unit(1, "npc"), height = unit(1, "npc"))) +
    theme_void()
})

# Arrange plots into a grid layout
# With ncol=2, the plots will fill the grid according to your specified order
plot_grid <- cowplot::plot_grid(plotlist = plots, ncol = 2)

# Display the combined plot
print(plot_grid)

# Save the combined plot to a file
output_file <- file.path(figure_directory, "FIGURE2_DRAFT.png")
ggsave(output_file, plot_grid, width = 11, height = 8.5)


```

# Make Supplemental Figure 1 - Gather .png figures from a specific folder location and compile them into a publication-ready graph with specified order
```{r}
# Define the directory containing the figures
figure_directory <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2025-09-27_GAMMs/cyclic_time_impute/plots/hormgammfig/ov_cent"

# List all PNG files in the directory
png_files <- list.files(figure_directory, pattern = "\\.png$", full.names = TRUE)

# Print just the text filenames without the full path
print(basename(png_files))

```

```{r}
# --------------------------------------------------------------------------
# NEW: Define the desired order of your plot filenames
# --------------------------------------------------------------------------
# List the base filenames (e.g., "my_plot.png") in the exact order
# you want them to appear in the grid (top-left, top-right, middle-left, etc.).
plot_order <- c(
  "gamplot_E2_Log_cyclic_time_imp_ov_20250927.png", "gamplot_LH_Log_cyclic_time_imp_ov_20250927.png", "gamplot_P4_Log_cyclic_time_imp_ov_20250927.png") 

# Create the full file paths based on your specified order
png_files <- file.path(figure_directory, plot_order)
# --------------------------------------------------------------------------


# Load each PNG file as a ggplot object
# This now loads the files in the order you defined above
plots <- lapply(png_files, function(file) {
  img <- png::readPNG(file)
  ggplot() +
    annotation_custom(rasterGrob(img, width = unit(1, "npc"), height = unit(1, "npc"))) +
    theme_void()
})

# Arrange plots into a grid layout
# With ncol=2, the plots will fill the grid according to your specified order
plot_grid <- cowplot::plot_grid(plotlist = plots, ncol = 1)

# Display the combined plot
print(plot_grid)

# Save the combined plot to a file
output_file <- file.path(figure_directory, "SuppFig1_DRAFT.png")
ggsave(output_file, plot_grid, width = 4, height = 9)
```

# Make Figure 3 SMMs - Gather .png figures from a specific folder location and compile them into a publication-ready graph with specified order
```{r}
# Define the directory containing the figures
figure_directory <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2025-09-28_SMMs/for_ms_SMM_figure"

# List all PNG files in the directory
png_files <- list.files(figure_directory, pattern = "\\.png$", full.names = TRUE)

# Print just the text filenames without the full path
print(basename(png_files))

```

 # "DRSP_1_log_g4_GAM_plot.png"  "DRSP_21_log_g3_GAM_plot.png",   "DRSP_4_log_g2_GAM_plot.png"        "DRSP_7_log_g3_GAM_plot.png"    
 
```{r}
# --------------------------------------------------------------------------
# NEW: Define the desired order of your plot filenames
# --------------------------------------------------------------------------
# List the base filenames (e.g., "my_plot.png") in the exact order
# you want them to appear in the grid (top-left, top-right, middle-left, etc.).
plot_order <- c(
     
  "CSS_Inatt_log_g2_GAM_plot.png",  
  "CSS_HypImp_log_g3_GAM_plot.png",
  "score_pinball_log_g2_GAM_plot.png", 
  "score_robot_log_g3_GAM_plot.png")

# Create the full file paths based on your specified order
png_files <- file.path(figure_directory, plot_order)
# --------------------------------------------------------------------------


# Load each PNG file as a ggplot object
# This now loads the files in the order you defined above
plots <- lapply(png_files, function(file) {
  img <- png::readPNG(file)
  ggplot() +
    annotation_custom(rasterGrob(img, width = unit(1, "npc"), height = unit(1, "npc"))) +
    theme_void()
})

# Arrange plots into a grid layout
# With ncol=2, the plots will fill the grid according to your specified order
plot_grid <- cowplot::plot_grid(plotlist = plots, ncol = 2)

# Display the combined plot
print(plot_grid)

# Save the combined plot to a file
output_file <- file.path(figure_directory, "SuppFig3_DRAFT.png")
ggsave(output_file, plot_grid, width = 14, height = 10)
```


