---
title: "ADHDCYCLE Daily Analysis Pipeline (Restored & Commented)"
output:
  html_document:
    toc: true
    fig_caption: true
    number_sections: true
    df_print: default
date: "Last compiled on `r format(Sys.time(), '%B %d, %Y')`"
---


```{r setup}
# This chunk sets the global options for the entire R Markdown document.
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
options(scipen = 999, digits = 3)
```

# Load Required Libraries

```{r libraries}
# This chunk loads all the packages needed for the analysis.
library(tidyverse)       # A collection of essential packages for data manipulation and visualization (includes dplyr, ggplot2, etc.)
library(janitor)         # Provides functions for cleaning data and table creation.
library(haven)           # For reading data from other statistical software like SPSS (.sav).
library(readxl)          # For reading data from Excel files (.xls, .xlsx).
library(zoo)             # For calculating rolling averages.
library(lubridate)       # For making it easier to work with dates and times.
library(conflicted)      # Helps manage function name conflicts between packages.
#remotes::install_github("eisenlohrmoullab/menstrualcycleR")
library(menstrualcycleR) # For cycle-specific analyses like PACTS scaling.
library(gridExtra)       # For arranging multiple plots on one page.
library(ggvenn)          # For creating Venn diagrams.
library(readr)       # For reading CSV files
library(dplyr)       # For data wrangling
library(lubridate)   # For date parsing/manipulation
library(tidyr)       # For tidying data
library(rlang)       # For tidy evaluation
library(visdat)      # For missing data visualization
library(ggpubr)      # For publication-ready plots
library(tidyverse) 
library(mgcv)      
library(readr)     
library(knitr)     
library(lme4)
library(gratia)
library(patchwork)
# Explicitly state our function preferences to avoid ambiguity when multiple
# packages have a function with the same name.
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
conflict_prefer("select", "dplyr")
conflict_prefer("summarize", "dplyr")
```

# --- Input File Paths (Using Your Direct, Hardcoded Paths) ---

```{r filepaths}
# Define the full path to each raw data file needed for the analysis.

path_raw_daily <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/02_datasets/02_data_prep_workspace/2025-08-20/20[...]"

path_raw_daily_2 <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/02_datasets/01_raw_data/DailySurveysTasks/dail[...]"

path_supp_hormones <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/02_datasets/03_cleaned_data/adhdcyc_daily_20[...]"

path_final_hormone_batch <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/02_datasets/02_data_prep_workspace/202[...]"

path_final_dates <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/02_datasets/02_data_prep_workspace/2025-10-30/[...]"
```

# --- Output Folder ---

```{r define_box_output}

# Define a base output location and create a unique, timestamped subfolder for this specific run.
output_folder_base <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code[...]"
output_folder <- file.path(output_folder_base, format(Sys.Date(), "%Y-%m-%d_Run"))
if (!dir.exists(output_folder)) {
  dir.create(output_folder, recursive = TRUE)
}
```

# --- Variable Lists ---

```{r varlists}
# Define the final variable names that will be processed and analyzed.
dv_list <- c("CSS_Inatt", "CSS_HypImp", "score_pinball_rev", "score_robot_rev", "BDEFS_Total", "BDEFS_WM_avg", "BDEFS_RI_avg", "UPPS_NU_avg", "UPPS_PU_avg", "UPPS_Premed_avg", "UPPS_Persev_avg", "UPPS[...]"
hormlist <- c("E2", "P4", "LH")
alldailyvars <- c(dv_list, hormlist)
corrplotlist <- c("CSS_Inatt", "CSS_HypImp", "score_pinball", "score_robot", "BDEFS_WM_avg", "BDEFS_RI_avg", "DEBQ_Total", "DRSP_1", "DRSP_4", "DRSP_7", "DRSP_16",  "E2", "P4", "LH")
```

# --- Plotting Configuration ---

```{r plot-config}

# This table controls which plots are generated in the final plotting loop.
metrics_to_plot <- tibble::tribble(
  # ~metric_filter: Which calculated metric to plot.
  # ~folder_name: The subfolder where these plots will be saved.
  # ~plot_subtitle: The subtitle that will appear on the plot.
  # ~needs_facet: TRUE if variables have different scales (like raw values) and need separate panels.
  # ~y_axis_label: The label for the y-axis.
  ~metric_filter, ~folder_name, ~plot_subtitle, ~needs_facet, ~y_axis_label,
  "raw", "01_raw_faceted", "Raw Daily Values", TRUE, "Hormone Value",
  "3roll", "02_raw_3roll_faceted", "3-Day Rolling Average", TRUE, "Hormone Value",
  "5roll", "03_raw_5roll_faceted", "5-Day Rolling Average", TRUE, "Hormone Value",
  "3roll.zd", "04_person_standardized_3roll", "Person-Standardized 3-Day Rolling Average", FALSE, "Standardized Value (Z-Score)",
  "3roll.szd", "05_sample_standardized_3roll", "Sample-Standardized 3-Day Rolling Average", FALSE, "Standardized Value (Z-Score)",
  "szd", "06_sample_standardized_raw", "Sample-Standardized Raw Values", FALSE, "Standardized Value (Z-Score)")
```

# --- 1. Load All Data Sources ---
```{r}
# Read each raw data source from its respective file path
raw_daily <- read_sav(path_raw_daily)
raw_daily_2 <- read_sav(path_raw_daily_2)
supp_hormones_all <- read_csv(path_supp_hormones, show_col_types = FALSE)
final_hormone_batch <- read_csv(path_final_hormone_batch, show_col_types = FALSE)
```

# --- 2. Standardize id/daterated column names for all sources ---
```{r}
# Function to rename columns in each data frame to a common set for merging
standardize_index_names <- function(df) {
  df %>%
    rename_with(~ case_when(
      str_detect(.x, regex("^(id|subjectid|ID)$", ignore_case=TRUE)) ~ "id",
      str_detect(.x, regex("^(date.?rated|date_rated|dateRated|rated_date|date)$", ignore_case=TRUE)) ~ "daterated",
      str_detect(.x, regex("^(estradiol|estrogen|e2|E2)$", ignore_case=TRUE)) ~ "E2",
      str_detect(.x, regex("^(progesterone|p4|prog|P4)$", ignore_case=TRUE)) ~ "P4",
      TRUE ~ .x, 
      ))
}
```