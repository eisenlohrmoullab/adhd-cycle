---
title: "ADHDCYCLE_daily_analysis"
author: "Tory Eisenlohr-Moul"
date: "`r Sys.Date()`"
output: html_document
---


# ---------------------------------------------------------------------------------- SETUP


# ---- Setup ----
- Turns of Scientific Notation
- Saves 'current_date' as a string in YYYYMMDD format
- Sets the number of digits (3) to display in output
- Saves Current Date as a string in YYYYMMDD format
- Sets the 'output_folder' as path to the output folder for saving files
```{r setup}

knitr::opts_chunk$set(echo = TRUE) # Setting options for knitr to display R code in output
options(scipen = 999) # Turn off scientific notation
options(digits = 3) # Set number of digits to display

current_date <- format(Sys.Date(), "%Y%m%d")  # Produces date as YYYYMMDD

output_folder <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-20/"

```


# ---- Load Packages (no cache) ----
```{r packages, warning=FALSE}

# ---- Global Chunk Options and Settings ----

# Setting options for knitr to display R code in output
knitr::opts_chunk$set(echo = TRUE)

# Prevent scientific notation in outputs
options(scipen = 999)

# ---- Data Manipulation and Cleaning ----

# Core tidyverse libraries for data manipulation and visualization
library(dplyr)       # Data manipulation (part of tidyverse)
library(tidyr)       # Data tidying (part of tidyverse)
library(tidyverse)   # Meta-package, includes dplyr, tidyr, ggplot2, and others
library(janitor)     # For cleaning data, e.g., renaming columns, removing empty rows
library(skimr)       # Summarize and inspect data quickly


# ---- Reading and Working with Files ----

# Libraries for reading various file formats
library(haven)       # For reading SPSS, Stata, and SAS files
library(readxl)      # For reading Excel files
library(readr)       # For reading CSV and other text files


# ---- Plotting and Visualization ----

# Core and extended libraries for data visualization
library(ggplot2)     # Core plotting library
library(ggdist)      # Visualizing distributions and uncertainty
library(ggforce)     # Extending ggplot2 functionality with advanced features
library(ggrepel)     # For adding non-overlapping text labels to ggplot2
library(visdat)      # Visualizing missing data and data structure
library(sjPlot)      # Plotting for statistical models (e.g., mixed models)
library(corrplot)    # For creating correlation matrix visualizations
library(grid)        # Base R graphics system for visual layout
library(gridExtra)   # Arranging multiple plots in a grid
library(see)         # Visualizing model checks and diagnostics
library(DescTools)  # Descriptive statistics and plotting tools

# ---- Time Series and Rolling Averages ----

# Libraries for time series data and handling dates
library(zoo)         # Working with rolling means/averages and time series
library(lubridate)   # Date and time manipulation


# ---- Mixed-Effects Models and Analysis ----

# Libraries for mixed-effects models and related analysis
library(lme4)        # Fitting mixed-effects models (linear and generalized)
library(lmerTest)    # Adds p-values for lme4 models
library(nlme)        # Linear and nonlinear mixed-effects models
library(emmeans)     # Compute estimated marginal means (EMMs) for model outputs
library(broom.mixed) # Tidying mixed model results into tidy data frames
library(performance) # Model performance metrics (e.g., R-squared for mixed models)
library(pbkrtest)    # Parametric bootstrap and Kenward-Roger methods for mixed models

# Generalized additive models and marginal effects
library(mgcv)        # Fitting generalized additive models (GAMs)
library(marginaleffects) # Tools for calculating marginal effects from regression models


# ---- Statistical Tools ----

# Libraries for specific statistical methods
#library(psych)       # Descriptive statistics and psychometrics
#library(GPArotation) # Factor analysis rotations (e.g., Varimax)
library(rmcorr)      # Repeated measures correlations
#library(MASS)        # Functions for statistical methods, e.g., Mahalanobis distance
library(careless)    # Detecting careless responses in surveys
library(responsePatterns) # Analyzing response patterns in data


# ---- GitHub, Project Management, and Reproducibility ----

# Libraries for project and version control management
library(usethis)     # Simplifies setting up GitHub repositories and managing projects
library(gitcreds)    # Managing Git credentials for GitHub interactions
#library(renv)        # Manages dependencies for reproducible environments
#library(targets)     # Workflow management for reproducible research pipelines
```

# ---- Check for Package Conflicts and Declare Preferences (no cache) ----
```{r package conflicts, warning=FALSE}
library(conflicted) # Managing conflicts between package namespaces

conflict_scout() # Check for conflicts between package namespaces

conflicts_prefer(dplyr::filter)
conflicts_prefer(tidyr::complete)
conflicts_prefer(dplyr::lag)
```


# ---- Store Global Lists of final variable names and labels ----
- Create Lists of Variables for Analysis
-   @dv_list: List of dependent variables for analysis
-   @hormlist: List of hormone variables for analysis
-   @alldailyvars: dv_list and hormlist combined

```{r make lists, cache=TRUE}

dv_list <- c(
  "CSS_Inatt",
  "CSS_HypImp",
  "score_pinball",
  "score_robot",
  "BDEFS_Total",
  "BDEFS_WM_avg",
  "BDEFS_RI_avg",
  "UPPS_NU_avg",
  "UPPS_PU_avg",
  "UPPS_Premed_avg",
  "UPPS_Persev_avg",
  "UPPS_Sens_avg",
  "DEBQ_Total",
  "CSS_Inatt_Count",
  "CSS_Hyp_Count",
  "CSS_Imp_Count",
  "CSS_HypImp_Count",
  "DRSP_1",
  "DRSP_2",
  "DRSP_3",
  "DRSP_4",
  "DRSP_5",
  "DRSP_6",
  "DRSP_7",
  "DRSP_8",
  "DRSP_9",
  "DRSP_10",
  "DRSP_11",
  "DRSP_12",
  "DRSP_13",
  "DRSP_14",
  "DRSP_15",
  "DRSP_16",
  "DRSP_17",
  "DRSP_18",
  "DRSP_19",
  "DRSP_20",
  "DRSP_21",
  "DRSP_22",
  "DRSP_23"
) %>% noquote()



# Rename the variables based on DRSP items
# This creates a named vector to assign meaningful labels to each variable for better interpretation in the plots
names(dv_list) <- c(
  "Inattention Sx", 
  "Hyperactivity/Imp Sx", 
  "Pinball Score",
  "Robot Score",
  "BDEFS Total",
  "BDEFS Working Memory",
  "BDEFS Resp Inhibition",
  "Negative Urgency",
  "Positive Urgency",
  "Lack of Premeditation",
  "Lack of Perseverance",
  "Sensation Seeking",
  "DEBQ Total",
  "Inattention Sx Count",
  "Hyperactivity Sx Count",
  "Impulsivity Sx Count",
  "Hyp/Imp Sx Count",
  "Depressed Mood", # DRSP_1
  "Hopelessness", # DRSP_2
  "Worthlessness/Guilt", # DRSP_3
  "Anxiety/Tension", # DRSP_4
  "Mood Swings", # DRSP_5
  "Rejection Sensitivity", # DRSP_6
  "Anger/Irritability", # DRSP_7
  "Interpersonal Conflict", # DRSP_8
  "Less Interest", # DRSP_9
  "Difficulty Concentrating", # DRSP_10
  "Lethargy/Fatigue", # DRSP_11
  "Incr Appetite/Overate", # DRSP_12
  "Food Cravings", # DRSP_13
  "Hypersomnia", # DRSP_14
  "Insomnia", # DRSP_15
  "Overwhelm/Can't Cope", # DRSP_16
  "Out of Control", # DRSP_17
  "Breast Tenderness", # DRSP_18
  "Swelling/Bloat/Wt Gain", # DRSP_19
  "Joint/Muscle Pain", # DRSP_20
  "Headache", # DRSP_21
  "Work/School Imp", 
  "Relational Imp"
)

# Rename the variables based on DRSP items
names(dv_list) <- c(
  "Depressed Mood", # DRSP_1
  "hopelessness", # DRSP_2
  "Worthlessness/Guilt", # DRSP_3
  "Anxiety/Tension", # DRSP_4
  "Mood Swings", # DRSP_5
  "Rejection Sensitivity", # DRSP_6
  "Anger/Irritability", # DRSP_7
  "Interpersonal Conflict", # DRSP_8
  "Less Interest", # DRSP_9
  "Difficulty Concentrating", # DRSP_10
  "Lethargy/Fatigue", # DRSP_11
  "Increased Appetite/Overate", # DRSP_12
  "Food Cravings", # DRSP_13
  "Hypersomnia", # DRSP_14
  "Insomnia", # DRSP_15
  "Overwhelm/Can't Cope", # DRSP_16
  "Out of Control", # DRSP_17
  "Breast Tenderness", # DRSP_18
  "Swelling/Bloating/Weight Gain", # DRSP_19
  "Joint/Muscle Pain", # DRSP_20
  "Headache", # DRSP_21
  "Work/School Impairment", 
  "Relational Impairment",
  "Inattention Symptoms", 
  "Hyperactivity/Impulsivity Symptoms", 
  "Pinball Score",
  "Robot Score",
  "BDEFS Total",
  "BDEFS Working Memory",
  "BDEFS Response Inhibition",
  "Negative Urgency",
  "Positive Urgency",
  "Lack of Premeditation",
  "Lack of Perseverance",
  "Sensation Seeking",
  "DEBQ Total",
  "Inattention Sx Count",
  "Hyperactivity Sx Count",
  "Impulsivity Sx Count",
  "Hyperactivity/Impulsivity Sx Count"
)

hormlist <- c(
  "E2",
  "P4",
  "LH"
) %>% noquote()

#Create another list that combines both dv_list and hormlist above
alldailyvars <- c(dv_list, hormlist) %>% noquote()
```


# Input dataset - CLEAN AS OF 2024-10-20

```{r}
# Load your CSV file (adjust the path to your actual file location)
df <- read_csv("~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/adhd_daily_df_20241020.csv")
```

# ---- Setting Variable Formats  ----
- Convert daterated to Date format using lubridate if necessary (ensure date format matches)
```{r updating formats, include=TRUE}

# Convert daterated to Date format using lubridate if necessary (ensure date format matches)
df <- df %>%
  mutate(daterated = case_when(
    !is.na(mdy(daterated)) ~ as.Date(mdy(daterated)),  # If mm/dd/yyyy
    !is.na(dmy(daterated)) ~ as.Date(dmy(daterated)),  # If dd/mm/yyyy
    !is.na(ymd(daterated)) ~ as.Date(ymd(daterated)),  # If yyyy-mm-dd
    TRUE ~ NA_Date_  # If parsing fails, set to NA
  ))
```

# ---- Sort df by id and daterated ----
```{r sort df}
df <- df %>%
  arrange(id, daterated)
```

# Check Association between cycleday variable and days since starting

```{r, cache=TRUE}

df$TubeNumber <- as.numeric(df$TubeNumber) # Convert TubeNumber to numeric

df_first <- df %>%
  group_by(id) %>%
  filter(TubeNumber == 1) %>%
  ungroup()

hist(df_first$scaled_cycleday, breaks = 30)


#cor(x=as.numeric(df$TubeNumber), y=df$scaled_cycleday, use="complete.obs")

#plot(x=as.numeric(df$TubeNumber), y=df$scaled_cycleday, use="complete.obs")

```


# 2024-10-20 - PLOTS - LUTEAL then FOLLICULAR - (OVULATION to OVULATION)

# Saved in 2024/10-20 folder

```{r, warning=FALSE, cache=TRUE}

# Define the function to generate plots for a list of DVs
plot_DVs <- function(dv_list, df) {
  
  # Create person-standardized (z-scored within each participant) versions of each DV
  for (DV in dv_list) {
    zd_var <- paste0(DV, ".zd")  # Name for the person-standardized version
    
    # Add the person-standardized columns for each DV
    df <- df %>%
      group_by(id) %>%
      mutate(!!zd_var := scale(!!sym(DV), center = TRUE, scale = TRUE)) %>%
      ungroup()
  }
  
  # Calculate person-rescaled E2 and P4 (scaled within each person, sd = 0.5)
  df <- df %>%
    group_by(id) %>%
    mutate(E2.rescale = scale(E2, center = TRUE, scale = sd(E2, na.rm=TRUE)/0.5), #changed here
           P4.rescale = scale(P4, center = TRUE, scale = sd(P4, na.rm=TRUE)/0.5)) %>% #changed here
    ungroup()
  
  # Indicators for menstrual bleeding
  bleeding_indicator <- data.frame(xmin = .5, xmax = 0.7, ymin = -Inf, ymax = Inf)
  
  for (DV in dv_list) {
    
    if (DV %in% c("E2", "P4", "LH")) {
      # Raw plot for E2, P4, LH
      dv <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(!!sym(DV), na.rm = TRUE),
                  se_value = sd(!!sym(DV), na.rm = TRUE) / sqrt(n()))  # SE calculation
      
      p1 <- ggplot(dv, aes(x = cycleday_10perc, y = mean_value)) +
        geom_ribbon(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                    fill = "black", alpha = 0.1) +
        geom_point(size = 1) +
        geom_line(size = 1) +
        ggtitle(paste("Raw", DV, "Plot")) +
        xlab("Cycle Day (10% bins)") + ylab(paste(DV, "Mean")) +
        theme_minimal() +
        theme(plot.title = element_text(hjust = 0.5, size = 14),
              plot.margin = margin(15, 5, 50, 5)) +
        coord_cartesian(clip = "off") +
        geom_rect(data = bleeding_indicator, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), 
                  fill = "red", alpha = 0.2, inherit.aes = FALSE)
      
      # Plot the data
      print(p1)
      
      ggsave(filename = paste0(output_folder, "/", DV, "_", "raw", ".png"), plot = last_plot(), width = 8, height = 6)

      
    } else {
      # For DVs that are NOT E2, P4, LH
      
      # Raw data points and line for the dependent variable
      dv <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(!!sym(DV), na.rm = TRUE),
                  se_value = sd(!!sym(DV), na.rm = TRUE) / sqrt(n()))  # SE calculation
      
    # Person-rescaled E2 and P4 lines (thin dotted)  <- Changed variable names here
      e2_std <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(E2.rescale, na.rm = TRUE)) #changed here

      p4_std <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(P4.rescale, na.rm = TRUE))  #changed here
      
      p1 <- ggplot(dv, aes(x = cycleday_10perc, y = mean_value)) +
        geom_ribbon(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                    fill = "black", alpha = 0.3) +
        geom_point(size = 1) +
        geom_line(size = 2) +
        # Thin dotted lines for E2 and P4
        # geom_line(data = e2_std, aes(x = cycleday_10perc, y = mean_value), 
        #           linetype = "dotted", color = "blue", size = 1, alpha = 0.6) +  # E2
        # geom_line(data = p4_std, aes(x = cycleday_10perc, y = mean_value), 
        #           linetype = "dotted", color = "forestgreen", size = 1, alpha = 0.6) +  # P4
        ggtitle(paste("Raw", DV, "Plot")) +
        xlab("Cycle Day (10% bins)") + ylab(paste(DV, "Mean")) +
        theme_minimal() +
        theme(plot.title = element_text(hjust = 0.5, size = 14),
              plot.margin = margin(15, 5, 50, 5)) +
        coord_cartesian(clip = "off") +
        geom_rect(data = bleeding_indicator, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), 
                  fill = "red", alpha = 0.2, inherit.aes = FALSE)
      
      # Plot the data
      print(p1)
      
      # Deviations plot
      dev_var <- paste0(DV, ".d")
      dv <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(!!sym(dev_var), na.rm = TRUE),
                  se_value = sd(!!sym(dev_var), na.rm = TRUE) / sqrt(n()))  # SE calculation
      
      p2 <- ggplot(dv, aes(x = cycleday_10perc, y = mean_value)) +
        geom_ribbon(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                    fill = "black", alpha = 0.3) +
        geom_point(size = 1) +
        geom_line(size = 2) +
        # geom_line(data = e2_std, aes(x = cycleday_10perc, y = mean_value), 
        #           linetype = "dotted", color = "blue", size = 1, alpha = 0.6) +  # E2
        # geom_line(data = p4_std, aes(x = cycleday_10perc, y = mean_value), 
        #           linetype = "dotted", color = "forestgreen", size = 1, alpha = 0.6) +  # P4
        ggtitle(paste("Deviations", DV, "Plot")) +
        xlab("Cycle Day (10% bins)") + ylab(paste(DV, "Deviation Mean")) +
        theme_minimal() +
        theme(plot.title = element_text(hjust = 0.5, size = 14),
              plot.margin = margin(15, 5, 50, 5)) +
        coord_cartesian(clip = "off") +
        geom_rect(data = bleeding_indicator, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), 
                  fill = "red", alpha = 0.2, inherit.aes = FALSE)
      
      print(p2)
      
            ggsave(filename = paste0(output_folder, "/", DV, "_", "dev", ".png"), plot = last_plot(), width = 8, height = 6)

      
      # Person-standardized outcome (zd)
      zd_var <- paste0(DV, ".zd")
      dv <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(!!sym(zd_var), na.rm = TRUE),
                  se_value = sd(!!sym(zd_var), na.rm = TRUE) / sqrt(n()))  # SE calculation
      
      p3 <- ggplot(dv, aes(x = cycleday_10perc, y = mean_value)) +
        geom_ribbon(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                    fill = "black", alpha = 0.3) +
        geom_point(size = 1) +
        geom_line(size = 2) +
        geom_line(data = e2_std, aes(x = cycleday_10perc, y = mean_value), 
                  linetype = "solid", color = "forestgreen", size = 1, alpha = 0.9) +  # E2
        geom_line(data = p4_std, aes(x = cycleday_10perc, y = mean_value), 
                  linetype = "solid", color = "red", size = 1, alpha = 0.8) +  # P4
        ggtitle(paste("Person-standardized", DV, "Plot")) +
        xlab("Cycle Day (10% bins)") + ylab(paste(DV, "Person-standardized Mean")) +
        theme_minimal() +
        theme(plot.title = element_text(hjust = 0.5, size = 14),
              plot.margin = margin(15, 5, 50, 5)) +
        coord_cartesian(clip = "off") +
        geom_rect(data = bleeding_indicator, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), 
                  fill = "red", alpha = 0.2, inherit.aes = FALSE)
      
      print(p3)
                  ggsave(filename = paste0(output_folder, "/", DV, "_", "zd", ".png"), plot = last_plot(), width = 8, height = 6)

      
      # Rolling deviations plot
      roll_dev_var <- paste0(DV, ".d.5roll")
      dv <- df %>%
        group_by(cycleday_10perc) %>%
        summarise(mean_value = mean(!!sym(roll_dev_var), na.rm = TRUE),
                  se_value = sd(!!sym(roll_dev_var), na.rm = TRUE) / sqrt(n()))  # SE calculation
      
      p4 <- ggplot(dv, aes(x = cycleday_10perc, y = mean_value)) +
        geom_ribbon(aes(ymin = mean_value - se_value, ymax = mean_value + se_value), 
                    fill = "black", alpha = 0.3) +
        geom_point(size = 1) +
        geom_line(size = 2) +
        # geom_line(data = e2_std, aes(x = cycleday_10perc, y = mean_value), 
        #           linetype = "dotted", color = "blue", size = 1, alpha = 0.6) +  # E2
        # geom_line(data = p4_std, aes(x = cycleday_10perc, y = mean_value), 
        #           linetype = "dotted", color = "forestgreen", size = 1, alpha = 0.6) +  # P4
        ggtitle(paste("Rolling Deviations", DV, "Plot")) +
        xlab("Cycle Day (10% bins)") + ylab(paste(DV, "Rolling Deviation Mean")) +
        theme_minimal() +
        theme(plot.title = element_text(hjust = 0.5, size = 14),
              plot.margin = margin(15, 5, 50, 5)) +
        coord_cartesian(clip = "off") +
        geom_rect(data = bleeding_indicator, aes(xmin = xmin, xmax = xmax, ymin = -Inf, ymax = Inf), 
                  fill = "red", alpha = 0.2, inherit.aes = FALSE)
      
      # Plot the data
      print(p4)
                  ggsave(filename = paste0(output_folder, "/", DV, "_", "rolld", ".png"), plot = last_plot(), width = 8, height = 6)

    }
  }
}

plot_DVs(dv_list, df)

```

# 2024-10-20 - PLOTS - FOLLICULAR then LUTEAL - (MENSES to MENSES)

# Saved in 2024/10-20 folder

```{r, warning=FALSE, cache=TRUE}


# Define the function to generate plots for a list of DVs
# Args:
#   dv_list: A named vector of dependent variables (DVs) to be plotted.
#   df: A data frame containing the data for analysis and plotting.
#   output_folder: The folder path where the generated plots should be saved.
plot_DVs_M2M <- function(dv_list, df, output_folder) {
  
  # Create person-standardized (z-scored within each participant) versions of each DV
  for (DV in dv_list) {
    zd_var <- paste0(DV, ".zd")  # Name for the person-standardized version
    
    # Add the person-standardized columns for each DV
    df <- df %>%
      group_by(id) %>%
      mutate(!!zd_var := scale(!!sym(DV), center = TRUE, scale = TRUE)) %>%
      ungroup()
  }
  
  # Calculate person-rescaled E2 and P4 (scaled within each person, sd = 0.5)
  # This transformation helps in visual comparison by keeping the SD consistent across participants
  df <- df %>%
    group_by(id) %>%
    mutate(E2.rescale = scale(E2, center = TRUE, scale = (sd(E2, na.rm = TRUE)*1.75)),
           P4.rescale = scale(P4, center = TRUE, scale = (sd(P4, na.rm = TRUE)*1.75))) %>%
    ungroup()
  
  # Indicators for menstrual bleeding (static values for highlighting cycle day range)
  bleeding_indicator <- data.frame(xmin = 0, xmax = 0.2, ymin = -Inf, ymax = Inf)
  
  # Loop through each DV to generate plots
  for (DV in dv_list) {
    # Get the label for the DV from dv_list
    DV_label <- names(dv_list)[which(dv_list == DV)]
    
    # Calculate mean and standard error for the raw dependent variable
    dv <- df %>%
      group_by(cycledayov_10perc) %>%
      summarise(mean_value = mean(!!sym(DV), na.rm = TRUE),
                se_value = sd(!!sym(DV), na.rm = TRUE) / sqrt(n()))  # SE calculation
    
    # Calculate mean and standard error for the person-z-scored outcome (zd)
    zd_var <- paste0(DV, ".zd")
    dv_zd <- df %>%
      group_by(cycledayov_10perc) %>%
      summarise(mean_value = mean(!!sym(zd_var), na.rm = TRUE),
                se_value = sd(!!sym(zd_var), na.rm = TRUE) / sqrt(n()))  # SE calculation
    
    # Generate plot for the person-standardized outcome (zd)
p3 <- ggplot(dv_zd, aes(x = cycledayov_10perc, y = mean_value)) +
  # Plotting the mean values for the person-standardized outcome with LOESS smoothing
  geom_smooth(method = "loess", span = .7, size = 1.5, se = FALSE, color = "black") +  # Use geom_smooth for the main DV with CI
  # Plotting the rescaled E2 and P4 values with LOESS smoothing
  geom_smooth(data = df, aes(x = cycledayov_10perc, y = E2.rescale, color = "E2"), method = "loess", span = 0.5, 
              linetype = "dashed", size = 1, alpha = 0.9, se = FALSE) +
  geom_smooth(data = df, aes(x = cycledayov_10perc, y = P4.rescale, color = "P4"), method = "loess", span = 0.5, 
              linetype = "dashed", size = 1, alpha = 0.8, se = FALSE) +
  # Manual color settings for different lines in the plot
  scale_color_manual(values = c("E2" = "forestgreen", "P4" = "red")) +
  # Set axis labels and plot title
  xlab("Cycle Day (10% bins)") + ylab(paste("Smoothed Person-Z-Scored", DV_label)) +
  # Apply minimal theme for cleaner look
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14),
        plot.margin = margin(15, 5, 50, 5),
        legend.title = element_blank(),
        legend.position = "right") +
  coord_cartesian(clip = "off") +
  ggtitle(label=DV_label)+
  # Highlight menstrual bleeding days with a red rectangle
  geom_rect(data = bleeding_indicator, aes(xmin = xmin, xmax = xmax, ymin = ymin, ymax = ymax), 
            fill = "red", alpha = 0.2, inherit.aes = FALSE)

# Print the plot to the graphics device
print(p3)
    
    # Save the plot to the specified output folder
    ggsave(filename = file.path(output_folder, paste0(DV, "_", "ov_zd_noSE", ".png")), plot = p3, width = 8, height = 6)
  }
}

# Call the function with the dataframe and output folder
plot_DVs_M2M(dv_list, df, output_folder)

```





# FITTING GAMMs 

# run_gamm_for_outcome(): This function runs a GAMM model for scaled_cycleday for a given outcome variable--  
# it logs the outcome, fits the model, performs hierarchical partitioning, 
# and saves both the model summary and partitioning output to a file.

# Saved in 2024/10-20 folder

```{r}

# Function to run GAMM for each outcome and save results
run_gamm_for_outcome <- function(outcome_var, df, output_folder) {
  # Step 1: Log-transform the outcome variable
  # The log transformation helps stabilize variance and normalize the data
  df[[paste0(outcome_var, "log")]] <- log(df[[outcome_var]] + 1)
  
  # Step 2: Fit a GAMM model
  # The model is fit using the log-transformed outcome variable.
  # The formula specifies random effects (bs = 're') for 'id' and 'scaled_cycleday',
  # and a smooth function (s) to capture the non-linear effect of scaled_cycleday.
  gamm_model <- gam(
    as.formula(paste0(outcome_var, "log ~ s(id, bs = 're') + s(scaled_cycleday, id, bs = 're') + s(scaled_cycleday, k = 20)")),
    data = df,
    method = "REML"  # REML (Restricted Maximum Likelihood) is used for model fitting
  )
  
  # Step 3: Output the model summary
  # The summary provides detailed information about the model fit,
  # including the significance of terms, smooth terms, and model diagnostics.
  model_summary <- summary(gamm_model)
  print(model_summary)
  
  # Step 4: Perform hierarchical partitioning
  # Hierarchical partitioning calculates the relative contribution of each predictor to the model fit.
  var_part <- gam.hp::gam.hp(gamm_model)
  print(var_part$hierarchical.partitioning)
  
  # Step 5: Capture the output for both model summary and hierarchical partitioning
  # The capture.output function stores the printed output in a character vector
  # that can be written to a file.
  summary_output <- capture.output(model_summary)
  partitioning_output <- capture.output(var_part$hierarchical.partitioning)
  
  # Step 6: Combine the model summary and hierarchical partitioning results
  # Here, both outputs are combined into a single object to be saved together.
  combined_output <- c(summary_output, "", "Hierarchical Partitioning:", partitioning_output)
  
  # Step 7: Define the output file path
  # The output file is saved with a name corresponding to the outcome variable.
  summary_file_path <- file.path(output_folder, paste0(outcome_var, "model.txt"))
  
  # Step 8: Save the combined output to a text file
  # This writes the model summary and hierarchical partitioning into the text file.
  writeLines(combined_output, summary_file_path)
  cat("Model summary and hierarchical partitioning saved to:", summary_file_path, "\n")
  
  # Step 9: Plot the GAMM model results
  # The plot shows the smooth term for 'scaled_cycleday' and its relationship with the outcome.
  # Select = 3 means we're selecting the smooth term corresponding to scaled_cycleday.
  #TODO: THIS IS OFF RIGHT NOW
  #plot.gam(gamm_model, select = 3)
  
  # Return the model object for further analysis if needed
  return(gamm_model)
}

# Step 10: Apply the function to each outcome in the list
# This will run the GAMM model for each outcome and save the results.
lapply(dv_list, run_gamm_for_outcome, df = df, output_folder = output_folder)

```









# GAMM and initial plot - E2 - Ov to Ov
```{r}

hist(df$E2)
df$E2log <- log(df$E2+1)
hist(df$E2log)

gamm_E2 <- gam(E2log ~ s(id, bs = "re") + 
                 s(scaled_cycleday, id, bs = "re") + 
                 s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_E2)


# Save the model summary as a text file
summary_output <- capture.output(summary(gamm_E2))
summary_file_path <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-17/E2model.txt"
writeLines(summary_output, summary_file_path)
cat("Model summary saved to:", summary_file_path, "\n")

var.part = gam.hp::gam.hp(gamm_E2)
var.part$hierarchical.partitioning

plot.gam(gamm_e2, select = 3)

```



# Model-Implied Plot - E2 - Ov to Ov
```{r}

e2dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_e2, newdata = e2dat, type = "response", transform = function(x) exp(x) - 1)

#don't need to include anything for 'transform' if your outcome is not log-transformed. This undoes the logtransform so model-implied values are not on the log scale 

e2dat$estimate = pred$estimate
e2dat$conf.low = pred$conf.low
e2dat$conf.high = pred$conf.high

# Plotting
e2plot <- ggplot(e2dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Salivary Estradiol") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

e2plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/E2.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)

```


# Load required libraries
library(VennDiagram)
library(ggplot2)
library(gam.hp)

# GAMM and initial plot - LH
```{r}
hist(df$LH) # Check the distribution of the LH variable
df$LHlog <- log(df$LH+1) # Log-transform the LH variable
hist(df$LHlog) # Check the distribution of the log-transformed LH variable



# Fit the model and save the summary
gamm_LH <- gam(LHlog ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re") + s(scaled_cycleday, k = 20), data = df, method = "REML")
summary_output <- capture.output(summary(gamm_LH))
summary_file_path <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/LHmodel.txt"
writeLines(summary_output, summary_file_path)
cat("Model summary saved to:", summary_file_path, "\n")

# Perform variance partitioning and extract data
var.part <- gam.hp::gam.hp(gamm_LH)
var_partition_data <- as.data.frame(var.part$hierarchical.partitioning)
data <- data.frame(Term = rownames(var_partition_data), I_perc = var_partition_data[, "I.perc(%)"])

# Create a bar plot using ggplot
ggplot(data, aes(x = Term, y = I_perc, fill = Term)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(title = "Percentage Contribution of Terms", x = "Term", y = "I.perc (%)") +
  theme_minimal() +
  theme(legend.position = "none")

# Extract variance contributions and overlaps for Venn diagram
venn_data <- setNames(as.list(var_partition_data[, "I.perc(%)"]), rownames(var_partition_data))
n12 <- var_partition_data[grep("s\(id, bs = \"re\"\)", rownames(var_partition_data)), "Average.share"]
n13 <- var_partition_data[grep("s\(scaled_cycleday, k = 20\)", rownames(var_partition_data)), "Average.share"]
n23 <- var_partition_data[grep("s\(scaled_cycleday, id, bs = \"re\"\)", rownames(var_partition_data)), "Average.share"]
n123 <- min(n12, n13, n23)

# Create and save the Venn diagram
png(filename = "variance_partitioning_venn.png", width = 800, height = 600)
draw.triple.venn(
  area1 = venn_data[[1]],
  area2 = venn_data[[2]],
  area3 = venn_data[[3]],
  n12 = n12,
  n13 = n13,
  n23 = n23,
  n123 = n123,
  category = names(venn_data),
  fill = c("red", "blue", "green"),
  lty = "blank",
  cex = 1.5,
  cat.cex = 1.5,
  main = "Variance Partitioning Venn Diagram"
)
dev.off()

# Display the Venn diagram in the RStudio viewer
grid::grid.newpage()
draw.triple.venn(
  area1 = venn_data[[1]],
  area2 = venn_data[[2]],
  area3 = venn_data[[3]],
  n12 = n12,
  n13 = n13,
  n23 = n23,
  n123 = n123,
  category = names(venn_data),
  fill = c("red", "blue", "green"),
  lty = "blank",
  cex = 1.5,
  cat.cex = 1.5,
  main = "Variance Partitioning Venn Diagram"
)



```


# Model-Implied Plot - LH
```{r}

LHdat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_LH, newdata = LHdat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

LHdat$estimate = pred$estimate
LHdat$conf.low = pred$conf.low
LHdat$conf.high = pred$conf.high

# Plotting
LHplot <- ggplot(LHdat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "LH") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

LHplot


ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/LH.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)

```


# GAMM and initial plot - P4
```{r}
hist(df$P4)
df$P4log <- log(df$P4+1)
hist(df$P4log)

gamm_P4 <- gam(P4log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 10), data = df, method = "REML")

summary(gamm_P4)


# Save the model summary as a text file
summary_output <- capture.output(summary(gamm_P4))
summary_file_path <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/gamm_P4.txt"
writeLines(summary_output, summary_file_path)
cat("Model summary saved to:", summary_file_path, "\n")

plot.gam(gamm_P4, select = 3)

```

# Model-Implied Plot - P4
```{r}

P4dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_P4, newdata = P4dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

P4dat$estimate = pred$estimate
P4dat$conf.low = pred$conf.low
P4dat$conf.high = pred$conf.high


# Plotting
P4plot <- ggplot(P4dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Salivary P4") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

P4plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/P4.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)

```









```{r}

# Function to run the GAMM and generate plots for a given outcome variable
gamm_model_loop <- function(outcome, df, output_path, plot_path) {
  
  # Step 1: Create a histogram for the outcome variable to check its distribution
  hist(df[[outcome]], main = paste("Histogram of", outcome), xlab = outcome)
  
  # Step 2: Log-transform the outcome variable to deal with skewness
  # Add 1 to avoid log(0) issues, which is undefined
  log_outcome <- paste0(outcome, "log")  # Create a name for the log-transformed variable
  df[[log_outcome]] <- log(df[[outcome]] + 1)  # Apply log transformation and store in a new column
  hist(df[[log_outcome]], main = paste("Histogram of Log-Transformed", outcome), xlab = log_outcome)  # Create a histogram for the transformed data
  
  # Step 3: Fit a Generalized Additive Mixed Model (GAMM)
  # The formula includes smooth terms for the id (random effect) and scaled_cycleday
  gamm_model <- gam(as.formula(paste0(log_outcome, " ~ s(id, bs = 're') + s(scaled_cycleday, id, bs = 're') + s(scaled_cycleday, k = 30)")),
                    data = df, method = "REML")  # REML method is recommended for smoother estimation
  
  # Step 4: Display the summary of the model
 summary(gamm_model)
  
  
  # Step 5: Save the model summary to a text file
  summary_output <- capture.output(summary(gamm_model))  # Capture the summary output as a character vector
  summary_file_path <- file.path(output_path, paste0("gamm_", outcome, ".txt"))  # Define the path to save the summary
  writeLines(summary_output, summary_file_path)  # Write the summary to the file
  cat("Model summary saved to:", summary_file_path, "\n")  # Print confirmation
  
  # Step 6: Create a dataset for making predictions from the model
  # We create a grid of values for scaled_cycleday ranging from -1 to 1
  pred_data <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),  # Values of scaled_cycleday for prediction
                           id = 0)  # We use id = 0 (population-level prediction)
  
  # Step 7: Make predictions using the `marginaleffects` package and undo the log transformation
  pred <- predictions(gamm_model, newdata = pred_data, type = "response", transform = function(x) exp(x) - 1)  # Use predictions function
  pred_data$estimate <- pred$estimate  # Store the predicted estimates
  pred_data$conf.low <- pred$conf.low  # Store the lower bound of the 95% confidence interval
  pred_data$conf.high <- pred$conf.high  # Store the upper bound of the 95% confidence interval
  
  # Step 8: Plot the predicted values and confidence intervals
  outcome_plot <- ggplot(pred_data, aes(x = scaled_cycleday, y = estimate)) +
    scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), 
                       labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +  # Custom labels for x-axis
    labs(x = "Cycle Day (Scaled)", y = outcome) +  # Labels for axes
    geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
              fill = "grey70", alpha = 0.2, color = "white") +  # Highlight the menses onset period
    geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
              fill = "grey87", alpha = 0.2, color = "white") +  # Highlight the ovulation period
    geom_line(size = 1, show.legend = TRUE) +  # Line plot for the estimated values
    theme_minimal()  # Use a minimal theme for cleaner visualization
  
  # Display the plot
  print(outcome_plot)
  
  # Step 9: Save the plot to a file
  plot_file_path <- file.path(plot_path, paste0(outcome, "_k30.png"))  # Define the path for saving the plot
  ggsave(filename = plot_file_path, plot = outcome_plot, width = 8, height = 6)  # Save the plot as a PNG file
  cat("Plot saved to:", plot_file_path, "\n")  # Print confirmation
}

# Define paths for saving outputs (modify as per your folder structure)
output_path <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/"
plot_path <- file.path(output_path, "GAMMplots_k30")

# List of outcomes to loop through (replace with your actual outcomes)
# already exists as "dv_list" above

# Loop through each outcome and apply the GAMM function
for (outcome in dv_list) {
  gamm_model_loop(outcome, df, output_path, plot_path)  # Apply the function to each outcome
}

```




# Trying a version of the loop that merges in E2: 

```{r}


gamm_model_loop <- function(outcome, df, output_path, plot_path) {
  
  # Step 1: Create a histogram for the outcome variable to check its distribution
  hist(df[[outcome]], main = paste("Histogram of", outcome), xlab = outcome)
  
  # Step 2: Log-transform the outcome variable to deal with skewness
  log_outcome <- paste0(outcome, "log")  
  df[[log_outcome]] <- log(df[[outcome]] + 1)  
  hist(df[[log_outcome]], main = paste("Histogram of Log-Transformed", outcome), xlab = log_outcome)
  
  # Step 3: Fit a GAMM
  gamm_model <- gam(as.formula(paste0(log_outcome, " ~ s(id, bs = 're') + s(scaled_cycleday, id, bs = 're') + s(scaled_cycleday, k = 30)")),
                    data = df, method = "REML")
  
  # Step 4: Save the model summary
  summary_output <- summary(gamm_model)
  summary_file_path <- file.path(output_path, paste0("gamm_", outcome, ".txt"))
  writeLines(capture.output(summary_output), summary_file_path)
  
  # Step 4a: Extract p-value and edf for scaled_cycleday
  scaled_cycleday_term <- summary_output$s.table["s(scaled_cycleday)", ]
  p_value <- scaled_cycleday_term["p-value"]
  edf <- scaled_cycleday_term["edf"]

  # Determine significance symbol
  significance <- ""
  if (p_value < 0.001) {
    significance <- "***"
  } else if (p_value < 0.01) {
    significance <- "**"
  } else if (p_value < 0.05) {
    significance <- "*"
  } else if (p_value < 0.15) {
    significance <- "†"
  }

 # Step 5: Create a dataset for predictions from the model
pred_data <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1), id = 0)
pred <- predict(gamm_model, newdata = pred_data, type = "response", se.fit = TRUE) # Predict on the link scale

# Calculate confidence intervals on the link scale
pred_data$conf.low <- pred$fit - 1.96 * pred$se.fit 
pred_data$conf.high <- pred$fit + 1.96 * pred$se.fit

# Transform predictions and confidence intervals to the response scale
pred_data$estimate <- exp(pred$fit) - 1
pred_data$conf.low <- exp(pred_data$conf.low) - 1
pred_data$conf.high <- exp(pred_data$conf.high) - 1

# Scale the transformed values  <-- This is the moved line
pred_data$estimate <- scale(pred_data$estimate)
pred_data$conf.low <- scale(pred_data$conf.low)
pred_data$conf.high <- scale(pred_data$conf.high) 

  # Step 6: Plot predicted values and confidence intervals for the outcome and add E2 curve
  outcome_plot <- ggplot(pred_data, aes(x = scaled_cycleday)) +
    scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), 
                       labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
    labs(x = "Cycle Day (Scaled)", y = "Scaled Predicted Values") +
    geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
              fill = "grey70", alpha = 0.2, color = "white") +
    geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
              fill = "grey87", alpha = 0.2, color = "white") +
    
    # Confidence ribbons for the outcome estimates
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "black", alpha = 0.1) +
    
    # Line plot for outcome
    geom_line(aes(y = estimate, color = "outcome"), size = 1, show.legend = TRUE) +  
    
    # Step 6a: Add E2 and P4 curves on top (using e2dat and P4dat)
    geom_line(data = e2dat, aes(x = scaled_cycleday, y = scale(estimate), color = "E2"), size = 1, linetype = "dashed") +  # E2 curve
    geom_line(data = P4dat, aes(x = scaled_cycleday, y = scale(estimate), color = "P4"), size = 1, linetype = "dashed") +  # P4 curve
    
    # Step 6b: Customize legend with desired order
    scale_color_manual(name = "Key", 
                       values = c("outcome" = "black", "E2" = "forestgreen", "P4" = "red"),
                       labels = c("outcome" = outcome, "E2" = "E2", "P4" = "P4"),
                       breaks = c("outcome", "E2", "P4")) +  # Ensure correct legend order
    
    theme_minimal() +
    theme(legend.position = "right")

  # Create a label for EDF and p-value, and add it below the legend
  annotation_text <- paste("EDF:", round(edf, 2), significance)
  annotated_plot <- ggdraw(outcome_plot) +
    draw_label(annotation_text, x = 0.85, y = 0.2, hjust = 0, size = 10, fontface = "bold")

  # Display the plot with annotation
  print(annotated_plot)

  # Step 7: Save the plot to a file
  plot_file_path <- file.path(plot_path, paste0(outcome, "_with_horm.png"))
  ggsave(filename = plot_file_path, plot = annotated_plot, width = 8, height = 6)
  cat("Plot with Hormone overlays saved to:", plot_file_path, "\n")
}

# Define paths for saving outputs (modify as per your folder structure)
output_path <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-10/"
plot_path <- file.path(output_path, "Plots with Hormone Overlays")

# Loop through each outcome and apply the GAMM function
for (outcome in dv_list) {
  gamm_model_loop(outcome, df, output_path, plot_path)  # Apply the function to each outcome
}

```


Alt Patchwork Code
```{r}

  library(patchwork)

# Create separate plots for Outcome, E2, and P4
outcome_plot <- ggplot(pred_data, aes(x = scaled_cycleday, y = estimate)) +
  geom_line(size = 1, color = "blue") +
  labs(x = "Cycle Day (Scaled)", y = outcome) +
  theme_minimal()

e2_plot <- ggplot(e2dat, aes(x = scaled_cycleday, y = estimate)) +
  geom_line(size = 1, color = "forestgreen", linetype = "dashed") +
  labs(x = "Cycle Day (Scaled)", y = "E2") +
  theme_minimal()

p4_plot <- ggplot(P4dat, aes(x = scaled_cycleday, y = estimate)) +
  geom_line(size = 1, color = "red", linetype = "dashed") +
  labs(x = "Cycle Day (Scaled)", y = "P4") +
  theme_minimal()

# Arrange all three plots in a single view
combined_plot <- outcome_plot / e2_plot / p4_plot
print(combined_plot)
```




# GAMM and initial plot - DRSP_1 - MS F, NS R
```{r}
hist(df$DRSP_1)
df$DRSP_1log <- log(df$DRSP_1+1)
hist(df$DRSP_1log)
gamm_DRSP_1 <- gam(DRSP_1log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_1)

plot.gam(gamm_DRSP_1, select = 3)

hist(df$DRSP_1)
```


# Model-Implied Plot - DRSP_1
```{r}

DRSP_1dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_1, newdata = DRSP_1dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_1dat$estimate = pred$estimate
DRSP_1dat$conf.low = pred$conf.low
DRSP_1dat$conf.high = pred$conf.high

# Plotting
DRSP_1plot <- ggplot(DRSP_1dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Depressed Mood") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_1plot


ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/depblue.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_2 - MS F, NS R
```{r}
hist(df$DRSP_2)
df$DRSP_2log <- log(df$DRSP_2+1)
hist(df$DRSP_2log)
gamm_DRSP_2 <- gam(DRSP_2log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_2)

plot.gam(gamm_DRSP_2, select = 3)

hist(df$DRSP_2)
```


# Model-Implied Plot - DRSP2
```{r}

DRSP_2dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_2, newdata = DRSP_2dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_2dat$estimate = pred$estimate
DRSP_2dat$conf.low = pred$conf.low
DRSP_2dat$conf.high = pred$conf.high

# Plotting
DRSP_2plot <- ggplot(DRSP_2dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Hopelessness") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_2plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/hopeless.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_3 - NS F, NS R
```{r}
hist(df$DRSP_3)
df$DRSP_3log <- log(df$DRSP_3+1)
hist(df$DRSP_3log)
gamm_DRSP_3 <- gam(DRSP_3log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_3)

plot.gam(gamm_DRSP_3, select = 3)

hist(df$DRSP_3)
```


# Model-Implied Plot - DRSP_3
```{r}

DRSP_3dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_3, newdata = DRSP_3dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_3dat$estimate = pred$estimate
DRSP_3dat$conf.low = pred$conf.low
DRSP_3dat$conf.high = pred$conf.high

# Plotting
DRSP_3plot <- ggplot(DRSP_3dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Worthlessness & Guilt") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_3plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/worthguilt.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_4 - MS F, SIG R
```{r}
hist(df$DRSP_4)
df$DRSP_4log <- log(df$DRSP_4+1)
hist(df$DRSP_4log)
gamm_DRSP_4 <- gam(DRSP_4log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_4)

plot.gam(gamm_DRSP_4, select = 3)

hist(df$DRSP_4)
```


# Model-Implied Plot - DRSP_4
```{r}

DRSP_4dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_4, newdata = DRSP_4dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_4dat$estimate = pred$estimate
DRSP_4dat$conf.low = pred$conf.low
DRSP_4dat$conf.high = pred$conf.high

# Plotting
DRSP_4plot <- ggplot(DRSP_4dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Anxiety & Tension") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_4plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/anxiety.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_5 - SIG F, SIG R
```{r}
hist(df$DRSP_5)
df$DRSP_5log <- log(df$DRSP_5+1)
hist(df$DRSP_5log)
gamm_DRSP_5 <- gam(DRSP_5log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_5)

plot.gam(gamm_DRSP_5, select = 3)

hist(df$DRSP_5)
```


# Model-Implied Plot - DRSP_5
```{r}

DRSP_5dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_5, newdata = DRSP_5dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_5dat$estimate = pred$estimate
DRSP_5dat$conf.low = pred$conf.low
DRSP_5dat$conf.high = pred$conf.high

# Plotting
DRSP_5plot <- ggplot(DRSP_5dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Mood Swings") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_5plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/moodswings.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_6 - NS F, MS R
```{r}
hist(df$DRSP_6)
df$DRSP_6log <- log(df$DRSP_6+1)
hist(df$DRSP_6log)
gamm_DRSP_6 <- gam(DRSP_6log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_6)

plot.gam(gamm_DRSP_6, select = 3)

hist(df$DRSP_6)
```


# Model-Implied Plot - DRSP_6
```{r}

DRSP_6dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_6, newdata = DRSP_6dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_6dat$estimate = pred$estimate
DRSP_6dat$conf.low = pred$conf.low
DRSP_6dat$conf.high = pred$conf.high

# Plotting
DRSP_6plot <- ggplot(DRSP_6dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Rejection Sensitivity") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_6plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/rejsens.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```



# GAMM and initial plot - DRSP_7 - SIG F, NS R
```{r}
hist(df$DRSP_7)
df$DRSP_7log <- log(df$DRSP_7+1)
hist(df$DRSP_7log)
gamm_DRSP_7 <- gam(DRSP_7log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_7)

plot.gam(gamm_DRSP_7, select = 3)

hist(df$DRSP_7)
```


# Model-Implied Plot - DRSP_7
```{r}

DRSP_7dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_7, newdata = DRSP_7dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_7dat$estimate = pred$estimate
DRSP_7dat$conf.low = pred$conf.low
DRSP_7dat$conf.high = pred$conf.high

# Plotting
DRSP_7plot <- ggplot(DRSP_7dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Anger or Irritability") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_7plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/angirr.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_8 - NS F, NS R
```{r}
hist(df$DRSP_8)
df$DRSP_8log <- log(df$DRSP_8+1)
hist(df$DRSP_8log)
gamm_DRSP_8 <- gam(DRSP_8log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_8)

plot.gam(gamm_DRSP_8, select = 3)

hist(df$DRSP_8)
```


# Model-Implied Plot - DRSP_8
```{r}

DRSP_8dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_8, newdata = DRSP_8dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_8dat$estimate = pred$estimate
DRSP_8dat$conf.low = pred$conf.low
DRSP_8dat$conf.high = pred$conf.high

# Plotting
DRSP_8plot <- ggplot(DRSP_8dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Interpersonal Conflict") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_8plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/intconf.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_9 - Sig F, NS R
```{r}
hist(df$DRSP_9)
df$DRSP_9log <- log(df$DRSP_9+1)
hist(df$DRSP_9log)
gamm_DRSP_9 <- gam(DRSP_9log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_9)

plot.gam(gamm_DRSP_9, select = 3)

hist(df$DRSP_9)
```


# Model-Implied Plot - DRSP_9
```{r}

DRSP_9dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_9, newdata = DRSP_9dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_9dat$estimate = pred$estimate
DRSP_9dat$conf.low = pred$conf.low
DRSP_9dat$conf.high = pred$conf.high

# Plotting
DRSP_9plot <- ggplot(DRSP_9dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Lack of Interest or Motivation") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_9plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/lackintmot.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_10 - NS F, NS R
```{r}
hist(df$DRSP_10)
df$DRSP_10log <- log(df$DRSP_10+1)
hist(df$DRSP_10log)
gamm_DRSP_10 <- gam(DRSP_10log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_10)

plot.gam(gamm_DRSP_10, select = 3)

hist(df$DRSP_10)
```


# Model-Implied Plot - DRSP_10
```{r}

DRSP_10dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_10, newdata = DRSP_10dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_10dat$estimate = pred$estimate
DRSP_10dat$conf.low = pred$conf.low
DRSP_10dat$conf.high = pred$conf.high

# Plotting
DRSP_10plot <- ggplot(DRSP_10dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Difficulty Concentrating") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_10plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/diffconc.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_11 - MS F, NS R
```{r}
hist(df$DRSP_11)
df$DRSP_11log <- log(df$DRSP_11+1)
hist(df$DRSP_11log)
gamm_DRSP_11 <- gam(DRSP_11log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_11)

plot.gam(gamm_DRSP_11, select = 3)

hist(df$DRSP_11)
```


# Model-Implied Plot - DRSP_11
```{r}

DRSP_11dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_11, newdata = DRSP_11dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_11dat$estimate = pred$estimate
DRSP_11dat$conf.low = pred$conf.low
DRSP_11dat$conf.high = pred$conf.high

# Plotting
DRSP_11plot <- ggplot(DRSP_11dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Lethargy, Fatigue") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_11plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/fatigue.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_12 - SIG F, NS R
```{r}
hist(df$DRSP_12)
df$DRSP_12log <- log(df$DRSP_12+1)
hist(df$DRSP_12log)
gamm_DRSP_12 <- gam(DRSP_12log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_12)

plot.gam(gamm_DRSP_12, select = 3)

hist(df$DRSP_12)
```


# Model-Implied Plot - DRSP_12
```{r}

DRSP_12dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_12, newdata = DRSP_12dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_12dat$estimate = pred$estimate
DRSP_12dat$conf.low = pred$conf.low
DRSP_12dat$conf.high = pred$conf.high

# Plotting
DRSP_12plot <- ggplot(DRSP_12dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Increased Appetite, Overeating") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_12plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/Appoverate.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_13 - SIG F, NS R
```{r}
hist(df$DRSP_13)
df$DRSP_13log <- log(df$DRSP_13+1)
hist(df$DRSP_13log)
gamm_DRSP_13 <- gam(DRSP_13log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_13)

plot.gam(gamm_DRSP_13, select = 3)

hist(df$DRSP_13)
```


# Model-Implied Plot - DRSP_13
```{r}

DRSP_13dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_13, newdata = DRSP_13dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_13dat$estimate = pred$estimate
DRSP_13dat$conf.low = pred$conf.low
DRSP_13dat$conf.high = pred$conf.high

# Plotting
DRSP_13plot <- ggplot(DRSP_13dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Food Cravings") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_13plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/foodcrave.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_14 - NS F, NS R
```{r}
hist(df$DRSP_14)
df$DRSP_14log <- log(df$DRSP_14+1)
hist(df$DRSP_14log)
gamm_DRSP_14 <- gam(DRSP_14log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_14)

plot.gam(gamm_DRSP_14, select = 3)

hist(df$DRSP_14)
```


# Model-Implied Plot - DRSP_14
```{r}

DRSP_14dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_14, newdata = DRSP_14dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_14dat$estimate = pred$estimate
DRSP_14dat$conf.low = pred$conf.low
DRSP_14dat$conf.high = pred$conf.high

# Plotting
DRSP_14plot <- ggplot(DRSP_14dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Hypersomnia") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_14plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/Hypersomnia.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_15 - NS F, NS R
```{r}
hist(df$DRSP_15)
df$DRSP_15log <- log(df$DRSP_15+1)
hist(df$DRSP_15log)
gamm_DRSP_15 <- gam(DRSP_15log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_15)

plot.gam(gamm_DRSP_15, select = 3)

hist(df$DRSP_15)
```


# Model-Implied Plot - TEMPLATE
```{r}

DRSP_15dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_15, newdata = DRSP_15dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_15dat$estimate = pred$estimate
DRSP_15dat$conf.low = pred$conf.low
DRSP_15dat$conf.high = pred$conf.high

# Plotting
DRSP_15plot <- ggplot(DRSP_15dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Insomnia") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_15plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/Insomnia.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_16 - NS F, NS R
```{r}
hist(df$DRSP_16)
df$DRSP_16log <- log(df$DRSP_16+1)
hist(df$DRSP_16log)
gamm_DRSP_16 <- gam(DRSP_16log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_16)

plot.gam(gamm_DRSP_16, select = 3)

hist(df$DRSP_16)
```


# Model-Implied Plot - DRSP_16
```{r}

DRSP_16dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_16, newdata = DRSP_16dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_16dat$estimate = pred$estimate
DRSP_16dat$conf.low = pred$conf.low
DRSP_16dat$conf.high = pred$conf.high

# Plotting
DRSP_16plot <- ggplot(DRSP_16dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Overwhelmed") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_16plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/overwhelm.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_17 - Sig F, NS R
```{r}
hist(df$DRSP_17)
df$DRSP_17log <- log(df$DRSP_17+1)
hist(df$DRSP_17log)
gamm_DRSP_17 <- gam(DRSP_17log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_17)

plot.gam(gamm_DRSP_17, select = 3)

hist(df$DRSP_17)
```


# Model-Implied Plot - TEMPLATE
```{r}

DRSP_17dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_17, newdata = DRSP_17dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_17dat$estimate = pred$estimate
DRSP_17dat$conf.low = pred$conf.low
DRSP_17dat$conf.high = pred$conf.high

# Plotting
DRSP_17plot <- ggplot(DRSP_17dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Out of Control") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_17plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/OOC.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```



# GAMM and initial plot - DRSP_18 - Sig F, Sig R
```{r}
hist(df$DRSP_18)
df$DRSP_18log <- log(df$DRSP_18+1)
hist(df$DRSP_18log)
gamm_DRSP_18 <- gam(DRSP_18log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_18)

plot.gam(gamm_DRSP_18, select = 3)

hist(df$DRSP_18)
```


# Model-Implied Plot - DRSP_18
```{r}

DRSP_18dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_18, newdata = DRSP_18dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_18dat$estimate = pred$estimate
DRSP_18dat$conf.low = pred$conf.low
DRSP_18dat$conf.high = pred$conf.high

# Plotting
DRSP_18plot <- ggplot(DRSP_18dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Breast Tenderness") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_18plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/Breast Tender.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DRSP_19 - SIG F, NS R
```{r}
hist(df$DRSP_19)
df$DRSP_19log <- log(df$DRSP_19+1)
hist(df$DRSP_19log)
gamm_DRSP_19 <- gam(DRSP_19log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_19)

plot.gam(gamm_DRSP_19, select = 3)

hist(df$DRSP_19)
```


# Model-Implied Plot - DRSP_19
```{r}

DRSP_19dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_19, newdata = DRSP_19dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_19dat$estimate = pred$estimate
DRSP_19dat$conf.low = pred$conf.low
DRSP_19dat$conf.high = pred$conf.high

# Plotting
DRSP_19plot <- ggplot(DRSP_19dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Swelling, Bloating, or Weight Gain") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_19plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/swellbloatgain.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```


# GAMM and initial plot - DSRP_20 - MS F, NS R
```{r}
hist(df$DRSP_20)
df$DRSP_20log <- log(df$DRSP_20+1)
hist(df$DRSP_20log)
gamm_DRSP_20 <- gam(DRSP_20log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_20)

plot.gam(gamm_DRSP_20, select = 3)

hist(df$DRSP_20)
```


# Model-Implied Plot - DSRP_20
```{r}

DRSP_20dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_20, newdata = DRSP_20dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_20dat$estimate = pred$estimate
DRSP_20dat$conf.low = pred$conf.low
DRSP_20dat$conf.high = pred$conf.high

# Plotting
DRSP_20plot <- ggplot(DRSP_20dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Headache") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_20plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/headache.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```




# GAMM and initial plot - DRSP_21 - NS F, NS R
```{r}
hist(df$DRSP_21)
df$DRSP_21log <- log(df$DRSP_21+1)
hist(df$DRSP_21log)
gamm_DRSP_21 <- gam(DRSP_21log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_21)

plot.gam(gamm_DRSP_21, select = 3)

hist(df$DRSP_21)
```


# Model-Implied Plot - DRSP_21
```{r}

DRSP_21dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_21, newdata = DRSP_21dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_21dat$estimate = pred$estimate
DRSP_21dat$conf.low = pred$conf.low
DRSP_21dat$conf.high = pred$conf.high

# Plotting
DRSP_21plot <- ggplot(DRSP_21dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Joint or Muscle Pain") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_21plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/jointmuscpain.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# GAMM and initial plot - DRSP_22 - Sig F, NS R
```{r}
hist(df$DRSP_22)
df$DRSP_22log <- log(df$DRSP_22+1)
hist(df$DRSP_22log)
gamm_DRSP_22 <- gam(DRSP_22log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_22)

plot.gam(gamm_DRSP_22, select = 3)

hist(df$DRSP_22)
```


# Model-Implied Plot - DRSP_22
```{r}

DRSP_22dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_22, newdata = DRSP_22dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_22dat$estimate = pred$estimate
DRSP_22dat$conf.low = pred$conf.low
DRSP_22dat$conf.high = pred$conf.high

# Plotting
DRSP_22plot <- ggplot(DRSP_22dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "School or Work Impairment") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_22plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/Workimp.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```



# GAMM and initial plot - DRSP_23 - MS F, NS R
```{r}
hist(df$DRSP_23)
df$DRSP_23log <- log(df$DRSP_23+1)
hist(df$DRSP_23log)
gamm_DRSP_23 <- gam(DRSP_23log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_DRSP_23)

plot.gam(gamm_DRSP_23, select = 3)

hist(df$DRSP_23)
```


# Model-Implied Plot - DRSP_23
```{r}

DRSP_23dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_DRSP_23, newdata = DRSP_23dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

DRSP_23dat$estimate = pred$estimate
DRSP_23dat$conf.low = pred$conf.low
DRSP_23dat$conf.high = pred$conf.high

# Plotting
DRSP_23plot <- ggplot(DRSP_23dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "Relationship Interference") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

DRSP_23plot

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/GAMMplots/relimp.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)
```

# Output all Model Files to Box

```{r}


# Define your list of outcomes
print(dv_list)

# Function to save summary of GAMM models to a file
save_gamm_summary <- function(outcome) {
  # Dynamically create model variable name
  model_var <- paste0("gamm_", outcome)
  
  # Dynamically create the file path for each outcome
  file_path <- paste0("/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-09-30/GAMMmodels/", outcome, "_gam_model_summary.txt")
  
  # Capture and write the summary to the file
  writeLines(capture.output(summary(get(model_var))), file_path)
}

# Loop over each outcome and save the summary
lapply(dv_list, save_gamm_summary)

```




##### Reference and template info below


# OUTCOMES

BDEFS_1, BDEFS_2, BDEFS_3, BDEFS_4, BDEFS_5, BDEFS_6, DRSP_1, DRSP_2, DRSP_3, DRSP_4, DRSP_5, DRSP_6, DRSP_7, DRSP_8, DRSP_9, DRSP_10, DRSP_11, DRSP_12, DRSP_13, DRSP_14, DRSP_15, DRSP_16, DRSP_17, DRSP_18, DRSP_19, DRSP_20, DRSP_21, DRSP_22, DRSP_23, CSS_B_1, CSS_B_2, CSS_B_3, CSS_B_4, CSS_B_5, CSS_B_6, CSS_B_7, CSS_B_8, CSS_B_9, CSS_B_10, CSS_B_11, CSS_B_12, CSS_B_13, CSS_B_14, CSS_B_15, CSS_B_16, CSS_B_17, CSS_B_18, CSS_Function_1, CSS_Function_2, CSS_Function_3, CSS_Function_4, CSS_Function_5, CSS_Function_6, CSS_Function_7, CSS_Function_8, CSS_Function_9, CSS_Function_10, CSS_B2_1, CSS_B2_2, CSS_B2_3, CSS_B2_4, CSS_B2_5, CSS_B2_6, CSS_B2_7, CSS_B2_8, UPPS_1, UPPS_2, UPPS_3, UPPS_4, UPPS_5, UPPS_6, UPPS_9, UPPS_10, UPPS_11, UPPS_12, UPPS_13, UPPS_14, UPPS_15, DEBQ_1, DEBQ_2, DEBQ_3, DEBQ_4, DEBQ_5, DEBQ_6, DEBQ_7, DEBQ_8, DEBQ_9, DEBQ_10, DEBQ_11, DEBQ_12, DEBQ_13

BDEFS_WM_avg, BDEFS_RI_avg, UPPS_NU_avg, UPPS_Persev_avg, UPPS_Premed_avg, UPPS_Sens_avg, UPPS_PU_avg, game_pinball, game_name_pinball, score_pinball, user_level_pinball, session_level_pinball, game_nth_pinball, game_lpi_pinball, RecordedDate_pinball, recorded_date_pinball, hour_recorded_pinball, midnight_to_seven_pinball, game_type_pinball, daterated_dontuse_pinball, game_robot, game_name_robot, score_robot, user_level_robot, session_level_robot, game_nth_robot, game_lpi_robot, RecordedDate_robot, recorded_date_robot, hour_recorded_robot, midnight_to_seven_robot, game_type_robot, daterated_dontuse_robot, nth_pinball_squared, nth_robot_squared, RES_robot, RES_pinball,


DRSP_1, DRSP_2, DRSP_3, DRSP_4, DRSP_5, DRSP_6, DRSP_7, DRSP_8, DRSP_9, DRSP_10, DRSP_11, DRSP_12, DRSP_13, DRSP_14, DRSP_15, DRSP_16, DRSP_17, DRSP_18, DRSP_19, DRSP_20, DRSP_21, DRSP_22, DRSP_23, UPPS_NU_avg, UPPS_Persev_avg, UPPS_Premed_avg, UPPS_Sens_avg, UPPS_PU_avg

# GAMM SCALED CYCLE DAY Effects - TEMPLATE MODEL
```{r}
hist(df$P4)
df$P4log <- log(df$P4+1)
hist(df$P4log)
gamm_p4 <- gam(P4log ~ s(id, bs = "re") + s(scaled_cycleday, id, bs = "re")  + s(scaled_cycleday, k = 20), data = df, method = "REML")

summary(gamm_p4)

plot.gam(gamm_p4, select = 3)

hist(df$P4)
```


# GAMM SCALED CYCLE DAY Effects - TEMPLATE PLOT
```{r}

P4dat <- expand.grid(scaled_cycleday = seq(-1, 1, by = 0.1),
                      id = 0) 

# Predict using the model for each dataset and add predictions
pred <- predictions(gamm_p4, newdata = P4dat, type = "response", transform = function(x) exp(x) - 1)

#, transform = function(x) exp(x) - 1) #don't need to include anything for 'transform' if your outcome is not log-transformed. This undo's the logtransform so model-implied values are not on the log scale 

P4dat$estimate = pred$estimate
P4dat$conf.low = pred$conf.low
P4dat$conf.high = pred$conf.high

# Plotting
P4plot <- ggplot(P4dat, aes(x = scaled_cycleday, y = estimate)) +
  scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.50), labels = c("0%L", "50%L", "Menses Onset", "50%F", "Ovulation")) +
  labs(x = "", y = "P4") +
  geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf,
            fill = "grey70", alpha = 0.2, color = "white") +
  geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf,
            fill = "grey87", alpha = 0.2, color = "white") +
  #geom_point(size = 3) +
  geom_line(size = 1, show.legend = TRUE) +
  theme_minimal()

P4plot


```








# HORMONE MODELS

## Prepare Hormones

```{r}

#df$logE2 = log(df$E2 + 1)
#df$logP4 = log(df$P4 + 1)

df <- df %>%
  group_by(id) %>%
  mutate(
      logE2= log(E2+1), 
    logP4= log(P4+1),
    E2zd = scale(E2),
    P4zd = scale(P4),
    
    # Calculate 5th and 95th percentiles for E2 and P4 within each id
    E2_lower = quantile(E2zd, 0.05, na.rm = TRUE),
    E2_upper = quantile(E2zd, 0.95, na.rm = TRUE),
    P4_lower = quantile(P4zd, 0.05, na.rm = TRUE),
    P4_upper = quantile(P4zd, 0.95, na.rm = TRUE),
    
    # Manually Winsorize by clamping values to the 5th and 95th percentiles
    E2zd = pmin(pmax(E2zd, E2_lower), E2_upper),
    P4zd = pmin(pmax(P4zd, P4_lower), P4_upper),
    
    # Daily derivatives for E2 and P4
    E2zch = c(NA, diff(E2zd)),  # Winsorized E2 derivative
    P4zch = c(NA, diff(P4zd))   # Winsorized P4 derivative
  ) %>%
  filter(
    !is.na(E2zd) & !is.nan(E2zd) & !is.infinite(E2zd) &
      !is.na(P4zd) & !is.nan(P4zd) & !is.infinite(P4zd) &
      !is.na(E2zch) & !is.nan(E2zch) & !is.infinite(E2zch) &
      !is.na(P4zch) & !is.nan(P4zch) & !is.infinite(P4zch)
  ) %>%
  ungroup()


hist(df$E2zd)
hist(df$P4zd)

df <- df %>%
  group_by(id) %>%
  mutate(
    logE2= log(E2+1), 
    logP4= log(P4+1),
    E2zd = scale(E2),
    P4zd = scale(P4),
    
    # Calculate 5th and 95th percentiles for E2 and P4 within each id
    E2_lower = quantile(E2zd, 0.05, na.rm = TRUE),
    E2_upper = quantile(E2zd, 0.95, na.rm = TRUE),
    P4_lower = quantile(P4zd, 0.05, na.rm = TRUE),
    P4_upper = quantile(P4zd, 0.95, na.rm = TRUE),
    
    # Manually Winsorize by clamping values to the 5th and 95th percentiles
    E2zd = pmin(pmax(E2zd, E2_lower), E2_upper),
    P4zd = pmin(pmax(P4zd, P4_lower), P4_upper),
    
    # Daily derivatives for E2 and P4
    E2zch = c(NA, diff(E2zd)),  # Winsorized E2 derivative
    P4zch = c(NA, diff(P4zd))   # Winsorized P4 derivative
  ) %>%
  filter(
    !is.na(E2zd) & !is.nan(E2zd) & !is.infinite(E2zd) &
      !is.na(P4zd) & !is.nan(P4zd) & !is.infinite(P4zd) &
      !is.na(E2zch) & !is.nan(E2zch) & !is.infinite(E2zch) &
      !is.na(P4zch) & !is.nan(P4zch) & !is.infinite(P4zch)
  ) %>%
  ungroup()


```

# Looping through hormone effects - FIXED: E2zd, P4zd, E2zd*P4zd, E2zch, P4zch

```{r}

# Function to Loop Through Outcomes and Generate GAMM Models
create_gamm_models <- function(dv_list, df, save_dir) {
  for (outcome in dv_list) {
    # Prepare variables dynamically
    outcome_log <- paste0(outcome, "log")
    df[[outcome_log]] <- log(df[[outcome]] + 1)

    # Plot histogram for transformed outcome
    hist(df[[outcome]], main = paste("Histogram of", outcome))
    hist(df[[outcome_log]], main = paste("Histogram of Log-transformed", outcome))

    # GAMM model with hormone z-scores and derivatives
    gamm_formula <- as.formula(paste0(
      outcome_log, " ~ s(id, bs = \"re\") + s(E2zd) +",
      " s(P4zd)  + ti(E2zd, P4zd) +",
      " s(E2zch) + s(P4zch)"
    ))

    gamm_model <- gam(
      gamm_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Summary and plot of the model
    model_summary <- summary(gamm_model)
    print(model_summary)

    # Save the model summary as a text file
    summary_output <- capture.output(model_summary)
    summary_file_path <- file.path(save_dir, paste0(outcome, "_fixed__wzch_85_model_EP_summary.txt"))
    writeLines(summary_output, summary_file_path)
    cat("Model summary saved to:", summary_file_path, "\n")

    # Plot the GAMM effects
    plot.gam(gamm_model, select = 2, main = paste("Estrogen Effect on", outcome))
    plot.gam(gamm_model, select = 3, main = paste("Progesterone Effect on", outcome))
   plot.gam(gamm_model, select = 5, main = paste("Estrogen Change Effect on", outcome))
   plot.gam(gamm_model, select = 6, main = paste("Progesterone Change Effect on", outcome))

    # Simpler model without random effects for visualization
    gamm_simple_formula <- as.formula(paste0(
      outcome_log, " ~ s(E2zd) + s(P4zd) + ti(E2zd, P4zd)"
    ))

    gamm_model_simple <- gam(
      gamm_simple_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Create the grid for contour plot
    grid <- expand.grid(
      E2zd = seq(
        min(df$E2zd, na.rm = TRUE),
        max(df$E2zd, na.rm = TRUE),
        length.out = 100
      ),
      P4zd = seq(
        min(df$P4zd, na.rm = TRUE),
        max(df$P4zd, na.rm = TRUE),
        length.out = 100
      )
    )

    # Predict values
    grid$predicted <- predict(gamm_model_simple,
                              newdata = grid,
                              type = "response",
                              transform = function(x) exp(x) - 1)

    # Contour plot
    plot_title <- paste("Predicting", outcome, "from E2 and P4 (Person Standardized)")
    contour_plot <- ggplot() +
      geom_tile(data = grid, aes(x = E2zd, y = P4zd, fill = predicted)) +
      geom_contour(data = grid, aes(x = E2zd, y = P4zd, z = predicted), color = "black") +
      geom_point(data = df, aes(x = E2zd, y = P4zd), color = "black", alpha = 0.25) +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = median(grid$predicted)) +
      labs(x = "E2zd", y = "P4zd", fill = "Outcome") +
      theme_minimal() +
      ggtitle(plot_title)

    print(contour_plot)

    # Save the contour plot
    plot_file_path <- file.path(save_dir, paste0(outcome, "_85_wzch_fixed.png"))
    ggsave(filename = plot_file_path, plot = contour_plot, width = 8, height = 6)
    cat("Contour plot saved to:", plot_file_path, "\n")
  }
}

# CALL THE LOOP

#OutcomeList already exists above

create_gamm_models(dv_list, df, "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/EP_Models_Plots")

```



 
# TEMPLATE GAMM .zd and Derivative effects of Hormones - TEMPLATE

```{r}


hist(df$CSS_Inatt)
df$CSS_Inattlog <- log(df$CSS_Inatt+1)
hist(df$CSS_Inattlog)

gamm_hormzd_CSS_Inatt <- gam(
  CSS_Inattlog ~ s(id, bs = "re") + s(E2zd) + s(E2zd, id, bs = "re") +
    s(P4zd) + s(P4zd, id, bs = "re") + ti(E2zd, P4zd) +
    s(E2zch) + s(E2zch, id, bs = "re") + s(P4zch) + s(P4zch, id, bs = "re"),
  data = df,
  family = gaussian,
  method = "REML"
)

# Summary and plot of the model
summary(gamm_hormzd_CSS_Inatt)


# Save the model summary as a text file
summary_output <- capture.output(summary(gamm_hormzd_CSS_Inatt))
summary_file_path <- "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/EP_Models_Plots/CSS_Inatt_model_EP_summary.txt"
writeLines(summary_output, summary_file_path)
cat("Model summary saved to:", summary_file_path, "\n")

plot.gam(gamm_hormzd_CSS_Inatt, select=2) #Estrogen
plot.gam(gamm_hormzd_CSS_Inatt, select=4) #Progesterone
plot.gam(gamm_hormzd_CSS_Inatt, select=7) #Estrogen CHANGE
plot.gam(gamm_hormzd_CSS_Inatt, select=8) #Progesterone CHANGE


# Simpler model without random effects for visualization
gamm_horm_CSS_Inatt_simple <- gam(
  CSS_Inattlog ~ s(E2zd) + s(P4zd) + ti(E2zd, P4zd),
  data = df,
  family = gaussian,
  method = "REML"
)

# Create the grid for contour plot
grid <- expand.grid(
  E2zd = seq(
    min(df$E2zd, na.rm = TRUE),
    max(df$E2zd, na.rm = TRUE),
    length.out = 100
  ),
  P4zd = seq(
    min(df$P4zd, na.rm = TRUE),
    max(df$P4zd, na.rm = TRUE),
    length.out = 100
  )
)

# Predict values
grid$predicted <- predict(gamm_horm_CSS_Inatt_simple,
                          newdata = grid,
                          type = "response", 
                         transform = function(x) exp(x) - 1)

# Contour plot
ggplot() +
  geom_tile(data = grid, aes(x = E2zd, y = P4zd, fill = predicted)) +
  geom_contour(data = grid,
               aes(x = E2zd, y = P4zd, z = predicted),
               color = "black") +
  geom_point(
    data = df,
    aes(x = E2zd, y = P4zd),
    color = "black",
    alpha = 0.25
  ) +
  scale_fill_gradient2(
    low = "blue",
    mid = "white",
    high = "red",
    midpoint = median(grid$predicted)) +
  labs(x = "E2zd", y = "P4zd", fill = "Outcome") +
  theme_minimal() +
  ggtitle("Predicting CSS_Inatt from E2 and P4 (Person Standardized)")

ggsave(filename = "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-03/EP_Models_Plots/CSS_Inatt.png", 
       plot = last_plot(), 
       width = 8, 
       height = 6)

```



# Looping through hormone effects - FIXED E2zd*P4zd TENSOR PRODUCT SMOOTH

```{r}
library(plotly)
library(htmlwidgets)

# Function to Loop Through Outcomes and Generate GAMM Models
create_gamm_models <- function(dv_list, df, save_dir) {
  for (outcome in dv_list) {
    # Prepare variables dynamically
    outcome_log <- paste0(outcome, "log")
    df[[outcome_log]] <- log(df[[outcome]] + 1)

    # Plot histogram for transformed outcome
    hist(df[[outcome]], main = paste("Histogram of", outcome))
    hist(df[[outcome_log]], main = paste("Histogram of Log-transformed", outcome))

    # GAMM model with hormone z-scores and derivatives
    gamm_formula <- as.formula(paste0(
      outcome_log, " ~ s(id, bs = \"re\") + te(E2zd, P4zd)"
    ))

    gamm_model <- gam(
      gamm_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Summary and plot of the model
    model_summary <- summary(gamm_model)
    print(model_summary)

    # Save the model summary as a text file
    summary_output <- capture.output(model_summary)
    summary_file_path <- file.path(save_dir, paste0(outcome, "_fixed__wzch_85_model_EP_summary.txt"))
    writeLines(summary_output, summary_file_path)
    cat("Model summary saved to:", summary_file_path, "\n")

    # Plot the GAMM effects
   # plot.gam(gamm_model, select = 2, main = paste("Estrogen Effect on", outcome))
   # plot.gam(gamm_model, select = 3, main = paste("Progesterone Effect on", outcome))
  # plot.gam(gamm_model, select = 5, main = paste("Estrogen Change Effect on", outcome))
  # plot.gam(gamm_model, select = 6, main = paste("Progesterone Change Effect on", outcome))

    # Simpler model without random effects for visualization
    gamm_simple_formula <- as.formula(paste0(
      outcome_log, " ~ te(E2zd, P4zd)"
    ))

    gamm_model_simple <- gam(
      gamm_simple_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Create the grid for contour plot
    grid <- expand.grid(
      E2zd = seq(
        min(df$E2zd, na.rm = TRUE),
        max(df$E2zd, na.rm = TRUE),
        length.out = 100
      ),
      P4zd = seq(
        min(df$P4zd, na.rm = TRUE),
        max(df$P4zd, na.rm = TRUE),
        length.out = 100
      )
    )

    # Predict values
    grid$predicted <- predict(gamm_model_simple,
                              newdata = grid,
                              type = "response",
                              transform = function(x) exp(x) - 1)

    # Contour plot
    plot_title <- paste("Predicting", outcome, "from E2 and P4 (Person Standardized)")
    contour_plot <- ggplot() +
      geom_tile(data = grid, aes(x = E2zd, y = P4zd, fill = predicted)) +
      geom_contour(data = grid, aes(x = E2zd, y = P4zd, z = predicted), color = "black") +
      geom_point(data = df, aes(x = E2zd, y = P4zd), color = "black", alpha = 0.25) +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = median(grid$predicted)) +
      labs(x = "E2zd", y = "P4zd", fill = "Outcome") +
      theme_minimal() +
      ggtitle(plot_title)

    print(contour_plot)

    # Save the contour plot
    plot_file_path <- file.path(save_dir, paste0(outcome, "_te_zd_fixed.png"))
    ggsave(filename = plot_file_path, plot = contour_plot, width = 8, height = 6)
    cat("Contour plot saved to:", plot_file_path, "\n")
    
     # Create the 3D surface plot using Plotly
    grid_matrix <- matrix(grid$predicted, nrow = 100, byrow = TRUE)
    surface_plot <- plot_ly(
      x = seq(min(df$E2zd, na.rm = TRUE), max(df$E2zd, na.rm = TRUE), length.out = 100),
      y = seq(min(df$P4zd, na.rm = TRUE), max(df$P4zd, na.rm = TRUE), length.out = 100),
      z = ~grid_matrix
    ) %>%
      add_surface() %>%
      layout(
        title = paste("3D Surface Plot of E2zd and P4zd Interaction for", outcome),
        scene = list(
          xaxis = list(title = "E2zd"),
          yaxis = list(title = "P4zd"),
          zaxis = list(title = "Predicted Outcome")
        )
      )

    # Save the interactive surface plot as an HTML file
    surface_plot_file_path <- file.path(save_dir, paste0(outcome, "_zd_3D_surface.html"))
    saveWidget(surface_plot, surface_plot_file_path)
    cat("3D surface plot saved to:", surface_plot_file_path, "\n")
  }
}


# CALL THE LOOP

create_gamm_models(dv_list, df, "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-10/")

```

"DRSP_1", "DRSP_2", "DRSP_3", "DRSP_4", "DRSP_5", "DRSP_6", "DRSP_7", "DRSP_8", "DRSP_9", 
  "DRSP_10", "DRSP_11", "DRSP_12", "DRSP_13", "DRSP_14", "DRSP_15", "DRSP_16", "DRSP_17", 
  "DRSP_18", "DRSP_19", "DRSP_20", "DRSP_21", "DRSP_22", "DRSP_23",

# Looping through hormone effects - FIXED - RAW - TENSOR PRODUCT SMOOTH

```{r}

# Function to Loop Through Outcomes and Generate GAMM Models
create_gamm_models <- function(dv_list, df, save_dir) {
  for (outcome in dv_list) {
    # Prepare variables dynamically
    outcome_log <- paste0(outcome, "log")
    df[[outcome_log]] <- log(df[[outcome]] + 1)

    # Plot histogram for transformed outcome
    hist(df[[outcome]], main = paste("Histogram of", outcome))
    hist(df[[outcome_log]], main = paste("Histogram of Log-transformed", outcome))

    # GAMM model with hormone z-scores and derivatives
    gamm_formula <- as.formula(paste0(
      outcome_log, " ~ s(id, bs = \"re\") + te(E2, P4)"
    ))

    gamm_model <- gam(
      gamm_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Summary and plot of the model
    model_summary <- summary(gamm_model)
    print(model_summary)

    # Save the model summary as a text file
    summary_output <- capture.output(model_summary)
    summary_file_path <- file.path(save_dir, paste0(outcome, "_fixed_te_rawEP_model_EP_summary.txt"))
    writeLines(summary_output, summary_file_path)
    cat("Model summary saved to:", summary_file_path, "\n")

    # Plot the GAMM effects
   # plot.gam(gamm_model, select = 2, main = paste("Estrogen Effect on", outcome))
   # plot.gam(gamm_model, select = 3, main = paste("Progesterone Effect on", outcome))
  # plot.gam(gamm_model, select = 5, main = paste("Estrogen Change Effect on", outcome))
  # plot.gam(gamm_model, select = 6, main = paste("Progesterone Change Effect on", outcome))

    # Simpler model without random effects for visualization
    gamm_simple_formula <- as.formula(paste0(
      outcome_log, " ~ te(E2, P4)"
    ))

    gamm_model_simple <- gam(
      gamm_simple_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Create the grid for contour plot
    grid <- expand.grid(
      E2 = seq(
        min(df$E2, na.rm = TRUE),
        max(df$E2, na.rm = TRUE),
        length.out = 100
      ),
      P4 = seq(
        min(df$P4, na.rm = TRUE),
        max(df$P4, na.rm = TRUE),
        length.out = 100
      )
    )

    # Predict values
    grid$predicted <- predict(gamm_model_simple,
                              newdata = grid,
                              type = "response",
                              transform = function(x) exp(x) - 1)

    # Contour plot
    plot_title <- paste("Predicting", outcome, "from E2 and P4 (Person Standardized)")
    contour_plot <- ggplot() +
      geom_tile(data = grid, aes(x = E2, y = P4, fill = predicted)) +
      geom_contour(data = grid, aes(x = E2, y = P4, z = predicted), color = "black") +
      geom_point(data = df, aes(x = E2, y = P4), color = "black", alpha = 0.25) +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = median(grid$predicted)) +
      labs(x = "E2", y = "P4", fill = "Outcome") +
      theme_minimal() +
      ggtitle(plot_title)

    print(contour_plot)

    # Save the contour plot
    plot_file_path <- file.path(save_dir, paste0(outcome, "rawEP_te_fixed.png"))
    ggsave(filename = plot_file_path, plot = contour_plot, width = 8, height = 6)
    cat("Contour plot saved to:", plot_file_path, "\n")
    
    
  }
}


# CALL THE LOOP

#OutcomeList already exists above

create_gamm_models(dv_list, df, "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-04/")

```


# Looping through hormone effects - FIXED - RAW LOG - TENSOR PRODUCT SMOOTH

```{r}

# Function to Loop Through Outcomes and Generate GAMM Models
create_gamm_models <- function(dv_list, df, save_dir) {
  for (outcome in dv_list) {
    # Prepare variables dynamically
    outcome_log <- paste0(outcome, "log")
    df[[outcome_log]] <- log(df[[outcome]] + 1)

    # Plot histogram for transformed outcome
    hist(df[[outcome]], main = paste("Histogram of", outcome))
    hist(df[[outcome_log]], main = paste("Histogram of Log-transformed", outcome))

    # GAMM model with hormone z-scores and derivatives
    gamm_formula <- as.formula(paste0(
      outcome_log, " ~ s(id, bs = \"re\") + te(logE2 , logP4)"
    ))

    gamm_model <- gam(
      gamm_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Summary and plot of the model
    model_summary <- summary(gamm_model)
    print(model_summary)

    # Save the model summary as a text file
    summary_output <- capture.output(model_summary)
    summary_file_path <- file.path(save_dir, paste0(outcome, "_fixed_te_rawlogEP_model_EP_summary.txt"))
    writeLines(summary_output, summary_file_path)
    cat("Model summary saved to:", summary_file_path, "\n")

    # Plot the GAMM effects
   # plot.gam(gamm_model, select = 2, main = paste("Estrogen Effect on", outcome))
   # plot.gam(gamm_model, select = 3, main = paste("Progesterone Effect on", outcome))
  # plot.gam(gamm_model, select = 5, main = paste("Estrogen Change Effect on", outcome))
  # plot.gam(gamm_model, select = 6, main = paste("Progesterone Change Effect on", outcome))

    # Simpler model without random effects for visualization
    gamm_simple_formula <- as.formula(paste0(
      outcome_log, " ~ te(logE2 , logP4)"
    ))

    gamm_model_simple <- gam(
      gamm_simple_formula,
      data = df,
      family = gaussian,
      method = "REML"
    )

    # Create the grid for contour plot
    grid <- expand.grid(
      logE2  = seq(
        min(df$logE2 , na.rm = TRUE),
        max(df$logE2 , na.rm = TRUE),
        length.out = 100
      ),
      logP4 = seq(
        min(df$logP4, na.rm = TRUE),
        max(df$logP4, na.rm = TRUE),
        length.out = 100
      )
    )

    # Predict values
    grid$predicted <- predict(gamm_model_simple,
                              newdata = grid,
                              type = "response",
                              transform = function(x) exp(x) - 1)

    # Contour plot
    plot_title <- paste("Predicting", outcome, "from logE2  and logP4")
    contour_plot <- ggplot() +
      geom_tile(data = grid, aes(x = logE2 , y = logP4, fill = predicted)) +
      geom_contour(data = grid, aes(x = logE2 , y = logP4, z = predicted), color = "black") +
      geom_point(data = df, aes(x = logE2 , y = logP4), color = "black", alpha = 0.25) +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = median(grid$predicted)) +
      labs(x = "logE2 ", y = "logP4", fill = "Outcome") +
      theme_minimal() +
      ggtitle(plot_title)

    print(contour_plot)

    # Save the contour plot
    plot_file_path <- file.path(save_dir, paste0(outcome, "rawlogEP_te_fixed.png"))
    ggsave(filename = plot_file_path, plot = contour_plot, width = 8, height = 6)
    cat("Contour plot saved to:", plot_file_path, "\n")
  }
}


# CALL THE LOOP

#OutcomeList already exists above

create_gamm_models(dv_list, df, "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-04/")

# Simulate data for logE2, logP4, and outcome
logE2 <- seq(-2, 2, length.out = 100)
logP4 <- seq(-2, 2, length.out = 100)
z <- outer(logE2, logP4, function(e2, p4) sin(e2) * cos(p4)) # Replace with actual model estimates

plot_ly(x = ~logE2, y = ~logP4, z = ~z, type = "surface") %>%
  layout(title = "Interaction Effect of logE2 and logP4 on Outcome",
         scene = list(
           xaxis = list(title = "logE2"),
           yaxis = list(title = "logP4"),
           zaxis = list(title = "Predicted Outcome")
         ))


```






# Function for te(???? not sure) in 85 dataset with 3D html plot output
```{r}
# Load required libraries
library(dplyr)
library(tidyr)
library(tidyverse)
library(ggplot2)
library(gridExtra)
library(mgcv)
library(plotly)
library(htmlwidgets)

# Function to Loop Through Outcomes and Generate GAMM Models
create_gamm_models <- function(dv_list, df, save_dir) {
  for (outcome in dv_list) {
    # Prepare variables dynamically
    outcome_log <- paste0(outcome, "log")
    df <- df %>% mutate(!!outcome_log := log(!!sym(outcome) + 1))

    # Plot histogram for transformed outcome using ggplot2
    hist_orig <- ggplot(df, aes(x = !!sym(outcome))) +
      geom_histogram(binwidth = 0.5, fill = "skyblue", color = "black") +
      labs(title = paste("Histogram of", outcome), x = outcome, y = "Count") +
      theme_minimal()

    hist_log <- ggplot(df, aes(x = !!sym(outcome_log))) +
      geom_histogram(binwidth = 0.5, fill = "skyblue", color = "black") +
      labs(title = paste("Histogram of Log-transformed", outcome), x = paste0(outcome, " (log)"), y = "Count") +
      theme_minimal()

    # Arrange the two histograms side by side and save
    histograms <- grid.arrange(hist_orig, hist_log, ncol = 2)
    hist_file_path <- file.path(save_dir, paste0(outcome, "_histograms.png"))
    ggsave(filename = hist_file_path, plot = histograms, width = 12, height = 6)
    cat("Histograms saved to:", hist_file_path, "\n")

    # GAMM model with hormone z-scores and derivatives
    gamm_formula <- as.formula(paste0(
      outcome_log, " ~ s(id, bs = \"re\") + te(logE2 , logP4)"
    ))

    gamm_model <- gam(
      gamm_formula,
      data = df,
      family = gaussian(),
      method = "REML"
    )

    # Summary and plot of the model
    model_summary <- summary(gamm_model)
    print(model_summary)

    # Save the model summary as a text file
    summary_output <- capture.output(model_summary)
    summary_file_path <- file.path(save_dir, paste0(outcome, "_fixed_te_rawlogEP_model_EP_summary.txt"))
    writeLines(summary_output, summary_file_path)
    cat("Model summary saved to:", summary_file_path, "\n")

    # Simpler model without random effects for visualization
    gamm_simple_formula <- as.formula(paste0(
      outcome_log, " ~ te(logE2 , logP4)"
    ))

    gamm_model_simple <- gam(
      gamm_simple_formula,
      data = df,
      family = gaussian(),
      method = "REML"
    )

    # Create the grid for contour plot
    grid <- expand_grid(
      logE2 = seq(
        min(df$logE2, na.rm = TRUE),
        max(df$logE2, na.rm = TRUE),
        length.out = 100
      ),
      logP4 = seq(
        min(df$logP4, na.rm = TRUE),
        max(df$logP4, na.rm = TRUE),
        length.out = 100
      )
    )

    # Predict values for contour plot
    grid <- grid %>%
      mutate(predicted = predict(gamm_model_simple, newdata = ., type = "response"))

    # Contour plot using ggplot2
    plot_title <- paste("Predicting", outcome, "from logE2 and logP4")
    contour_plot <- ggplot(grid, aes(x = logE2, y = logP4, z = predicted)) +
      geom_tile(aes(fill = predicted)) +
      geom_contour(color = "black") +
      scale_fill_gradient2(low = "blue", mid = "white", high = "red", midpoint = median(grid$predicted, na.rm = TRUE)) +
      labs(x = "logE2", y = "logP4", fill = "Predicted Outcome") +
      theme_minimal() +
      ggtitle(plot_title)

    print(contour_plot)

    # Save the contour plot
    plot_file_path <- file.path(save_dir, paste0(outcome, "_rawlogEP_te_fixed.png"))
    ggsave(filename = plot_file_path, plot = contour_plot, width = 8, height = 6)
    cat("Contour plot saved to:", plot_file_path, "\n")

    # Create the 3D surface plot using Plotly
    grid_matrix <- matrix(grid$predicted, nrow = 100, byrow = TRUE)
    surface_plot <- plot_ly(
      x = seq(min(df$logE2, na.rm = TRUE), max(df$logE2, na.rm = TRUE), length.out = 100),
      y = seq(min(df$logP4, na.rm = TRUE), max(df$logP4, na.rm = TRUE), length.out = 100),
      z = ~grid_matrix
    ) %>%
      add_surface() %>%
      layout(
        title = paste("3D Surface Plot of logE2 and logP4 Interaction for", outcome),
        scene = list(
          xaxis = list(title = "logE2"),
          yaxis = list(title = "logP4"),
          zaxis = list(title = "Predicted Outcome")
        )
      )

    # Save the interactive surface plot as an HTML file
    surface_plot_file_path <- file.path(save_dir, paste0(outcome, "_3D_surface.html"))
    saveWidget(surface_plot, surface_plot_file_path)
    cat("3D surface plot saved to:", surface_plot_file_path, "\n")
  }
}

# CALL THE LOOP
create_gamm_models(dv_list, df, "/Users/taem-macbook-air/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/2024-10-04/")

```

