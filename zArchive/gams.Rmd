---
title: "ADHDCYCLE GAM Analysis (Automated Reporting)"
author: "Tory Eisenlohr-Moul, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

> **Script Purpose:** This script conducts a comprehensive, automated analysis of symptom cyclicity. The workflow is divided into three main parts:
> 1.  **Setup & Preparation:** Loads all necessary packages and data, and defines key parameters for the entire analysis.
> 2.  **Automated Reporting:** For **each participant**, this section generates a single, multi-page PDF. This report includes a **summary table** of significant findings, followed by detailed plots for **every outcome** and **every time variable**.
> 3.  **Publication Figure Generation:** Creates a specific, multi-panel figure for publication.

---

### 1. Setup & Configuration

This section prepares everything needed for the analysis. All user-adjustable parameters are consolidated here for easy modification.

#### 1.1: Load Libraries
```{r setup, message=FALSE, warning=FALSE}
library(dplyr)         # For data manipulation
library(ggplot2)       # For plotting
library(mgcv)          # For GAM modeling
library(marginaleffects) # For generating model predictions
library(patchwork)     # For combining final plots
library(gridExtra)     # For creating the summary table plot
library(grid)          # To access textGrob() and gpar()
library(tibble)        # For easier data frame manipulation
library(tidyr)         # For pivoting data
```

#### 1.2: User-Configurable Parameters ‚öôÔ∏è
```{r user-config}
# --- Path to the main output directory ---
gam_output_base <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/6_GAMs/"

# --- Define all Time Variables to iterate over ---
# The script will run a separate analysis for each time variable listed here.
time_vars_to_run <- c("cyclic_time", "cyclic_time_ov", "cyclic_time_impute", "cyclic_time_imp_ov")

# --- Plots Per PDF Page ---
plots_per_page <- 9 
```

#### 1.3: Automatic Setup
```{r auto-setup}
current_date <- format(Sys.Date(), "%Y%m%d")
output_folder <- file.path(gam_output_base, paste0("GAM_Reports_", current_date))
dir.create(output_folder, showWarnings = FALSE, recursive = TRUE)
```

#### 1.4: Load and Prepare Data
```{r data-prep}
# --- Load Dataset ---
# Assumes 'cycle_df_scaled' is loaded. If not, load it here.
# cycle_df_scaled <- read.csv("path/to/your/scaled_data.csv")

# --- Robustness Check: Verify that specified time variables exist in the data ---
time_vars <- intersect(time_vars_to_run, names(cycle_df_scaled))
if (length(time_vars) < length(time_vars_to_run)) {
  missing_vars <- setdiff(time_vars_to_run, time_vars)
  warning("The following time_vars were not found and will be skipped: ", paste(missing_vars, collapse = ", "))
}

# --- Define Outcomes to Model ---
outcomes <- c(
    "CSS_Inatt_Count" = "CSS Inattention Sx Count", "CSS_Hyp_Count" = "CSS Hyperactivity Sx Count",
    "CSS_Imp_Count" = "CSS Impulsivity Sx Count", "CSS_Inatt" = "CSS Inattention Sx Severity",
    "CSS_HypImp" = "CSS Hyperactivity/Impulsivity Sx Severity", "score_pinball" = "Working Memory Score (Pinball)",
    "score_robot" = "Response Inhibition (Robot Factory)", "BDEFS_WM_avg" = "Working Memory Sx (BDEFS)",
    "BDEFS_RI_avg" = "Response Inhibition Sx (BDEFS)", "DRSP_1" = "Depressed Mood", "DRSP_2" = "Hopelessness",
    "DRSP_3" = "Worthlessness/Guilt", "DRSP_4" = "Anxiety", "DRSP_5" = "Mood Swings",
    "DRSP_6" = "Rejection Sensitivity", "DRSP_7" = "Irritability", "DRSP_8" = "Interpersonal Conflicts",
    "DRSP_9" = "Less Interest in Activities", "DRSP_10" = "Difficulty Concentrating", "DRSP_11" = "Lethargy/Fatigue",
    "DRSP_12" = "Increased Appetite/Overate", "DRSP_13" = "Food Cravings", "DRSP_14" = "Hypersomnia",
    "DRSP_15" = "Insomnia", "DRSP_16" = "Overwhelmed/Couldn't Cope", "DRSP_17" = "Felt Out of Control",
    "DRSP_18" = "Breast Tenderness", "DRSP_19" = "Swelling/Bloating", "DRSP_20" = "Headache",
    "DRSP_21" = "Joint/Muscle Pain", "DRSP_22" = "Work Impairment", "DRSP_23" = "Relationship Impairment",
    "E2" = "Estradiol", "P4" = "Progesterone", "LH" = "Luteinizing Hormone"
)

# --- Pre-calculate all log-transformations for efficiency ---
for (var in names(outcomes)) {
  if (var %in% names(cycle_df_scaled)) {
    log_var_name <- paste0(var, "_Log")
    cycle_df_scaled[[log_var_name]] <- log(cycle_df_scaled[[var]] + 1)
  }
}
```

---

### 2. Automated Reporting: Generate Comprehensive PDF for Each Participant

This section iterates through every participant, running all models and generating a single PDF report. The first page is a compact significance table, followed by pages of model plots.

```{r automated-reporting, message=TRUE, warning=TRUE}
report_folder <- file.path(output_folder, "Participant_Reports_PDF")
dir.create(report_folder, showWarnings = FALSE, recursive = TRUE)

unique_ids <- unique(cycle_df_scaled$id)

for (current_id in unique_ids) {
  
  message(paste("--- Generating Full Report for ID:", current_id, "---"))
  
  # --- 1. MODELING STAGE ---
  all_predictions <- list()
  significance_results <- list()
  datSX_id <- subset(cycle_df_scaled, id == current_id)

  for (current_time_var in time_vars) {
    for (outcome_var in names(outcomes)) {
      
      log_outcome_var <- paste0(outcome_var, "_Log")
      if (!log_outcome_var %in% names(datSX_id)) next
      
      model_data <- datSX_id[complete.cases(datSX_id[, c(log_outcome_var, current_time_var)]), ]
      if (nrow(model_data) < 10 || var(model_data[[log_outcome_var]], na.rm = TRUE) < 1e-6) next
      
      tryCatch({
        adaptive_k <- min(10, nrow(model_data) - 1)
        if (adaptive_k < 3) next
        
        formula <- as.formula(paste(log_outcome_var, "~ s(", current_time_var, ", bs = 'cc', k = ", adaptive_k, ")"))
        knots <- list(c(-1, 1)); names(knots) <- current_time_var
        gamm <- mgcv::gam(formula, data = model_data, knots = knots, method = 'REML')
        
        p_value <- summary(gamm)$s.pv[1]
        significance_results[[length(significance_results) + 1]] <- 
          data.frame(outcome = outcomes[outcome_var], time_var = current_time_var, p.value = p_value)
        
        pred_grid <- expand.grid(time_points = seq(-1, 1, by = 0.05)); names(pred_grid)[1] <- current_time_var
        pred <- marginaleffects::predictions(gamm, newdata = pred_grid, type = "response", transform = function(x) exp(x) - 1)
        pred$outcome_label <- outcomes[outcome_var]
        pred$time_var_name <- current_time_var
        all_predictions[[length(all_predictions) + 1]] <- pred
        
      }, error = function(e) {})
    }
  }

  # --- 2. REPORT GENERATION STAGE ---
  if (length(all_predictions) == 0) {
    message(paste("--- No successful models for ID:", current_id, ". Skipping PDF generation. ---"))
    next
  }
  
  pdf_filename <- file.path(report_folder, paste0("Full_Report_ID_", current_id, ".pdf"))
  pdf(pdf_filename, width = 11, height = 8.5)

  # --- Page 1: Create a compact summary table ---
  summary_df <- dplyr::bind_rows(significance_results) %>%
    mutate(
      # Shorten time variable names for compact column headers
      time_var_short = gsub("cyclic_time_?", "", time_var),
      stars = case_when(p.value < 0.001 ~ "***", p.value < 0.01  ~ "**", p.value < 0.05  ~ "*", TRUE ~ "")
    ) %>%
    select(Outcome = outcome, `Time Variable` = time_var_short, P.Value = stars) %>%
    pivot_wider(names_from = `Time Variable`, values_from = P.Value, values_fill = "N/A")

  # üí° NEW: Use a smaller base_size in the theme to make the font smaller
  table_theme <- ttheme_minimal(base_size = 8, core = list(padding = unit(c(2, 2), "mm")))
  table_grob <- tableGrob(summary_df, rows = NULL, theme = table_theme)
  title_grob <- textGrob(paste("Significance of Cycle Effects for ID:", current_id), gp = gpar(fontsize = 16, fontface = "bold"))
  footnote_grob <- textGrob("* p < 0.05, ** p < 0.01, *** p < 0.001", gp = gpar(fontsize = 10, fontface = "italic"), hjust = 1)
  
  grid.arrange(title_grob, table_grob, footnote_grob, ncol = 1, heights = unit(c(0.1, 0.8, 0.1), "npc"))

  # --- Subsequent Pages: Create the plots ---
  combined_plot_data <- dplyr::bind_rows(all_predictions)
  
  for (current_time_var in time_vars) {
    plot_data_for_time_var <- dplyr::filter(combined_plot_data, time_var_name == current_time_var)
    if(nrow(plot_data_for_time_var) == 0) next

    # üí° NEW: Define intercepts and labels based on the time variable
    if (grepl("ov", current_time_var)) {
      axis_labels <- c("Menses", "50%F", "Ovulation", "50%L", "Menses")
      menses_intercepts <- c(-1, 1)
      ovulation_intercept <- 0
    } else {
      axis_labels <- c("Ovulation", "50%L", "Menses", "50%F", "Ovulation")
      menses_intercepts <- 0
      ovulation_intercept <- c(-1, 1)
    }
    
    modeled_outcomes <- unique(plot_data_for_time_var$outcome_label)
    outcome_groups <- split(modeled_outcomes, ceiling(seq_along(modeled_outcomes) / plots_per_page))
    
    for (page_outcomes in outcome_groups) {
      page_data <- dplyr::filter(plot_data_for_time_var, outcome_label %in% page_outcomes)
      
      page_plot <- ggplot(page_data, aes(x = .data[[current_time_var]], y = estimate)) +
        # üí° NEW: Add vertical lines for menses and ovulation behind the data
        geom_vline(xintercept = menses_intercepts, color = "red", linetype = "solid", linewidth = 0.8) +
        geom_vline(xintercept = ovulation_intercept, color = "forestgreen", linetype = "solid", linewidth = 0.8) +
        geom_line(linewidth = 1, color = "#0072B2") +
        geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#0072B2", alpha = 0.2) +
        facet_wrap(~ outcome_label, scales = "free_y", ncol = 3) + 
        scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.5), labels = axis_labels) +
        labs(
          title = paste("Symptom Trajectories for ID:", current_id),
          subtitle = paste("Time Variable:", current_time_var),
          x = "Cycle Phase", y = "Symptom Score"
        ) +
        theme_minimal() +
        theme(
            strip.text = element_text(face = "bold"), 
            plot.title = element_text(hjust = 0.5, face = "bold"), 
            plot.subtitle = element_text(hjust = 0.5)
        )
      
      print(page_plot)
    }
  }
  
  dev.off()
  message(paste("--- ‚úÖ Saved Full Report for ID:", current_id, "---"))
}
```

