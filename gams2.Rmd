---
title: "ADHDCYCLE Individual GAM Reports"
author: "Tory Eisenlohr-Moul, PhD"
date: "`r format(Sys.Date(), '%B %d, %Y')`"
output: html_document
---

> **Script Purpose:** This script conducts a comprehensive, automated analysis of symptom cyclicity. The workflow is divided into three main parts:
> 1.  **Setup & Preparation:** Loads packages and data, and defines key parameters.
> 2.  **Automated Reporting:** For each participant, this section runs all necessary models and generates a complete PDF report on-the-fly.
> 3.  **Publication Figure Generation:** Creates a specific figure for publication.

---

### 1. Setup & Configuration

This section prepares everything needed for the analysis.

#### 1.1: Load Libraries
```{r setup}
#install.packages(c("dplyr", "ggplot2", "mgcv", "marginaleffects", "patchwork", "gridExtra", "grid", "tibble", "tidyr"))

# load all packages
library(dplyr)
library(ggplot2)
library(mgcv)
library(marginaleffects)
library(patchwork)
library(gridExtra)
library(grid)
library(tibble)
library(tidyr)
library(knitr)
options(scipen = 999) # turn off scientific notation
set.seed(12345) # for reproducibility

```

#### 1.2: User-Configurable Parameters ‚öôÔ∏è
```{r user-config}
# --- Path to the main output directory ---
gam_output_base <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies/Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/6_GAMs/"

# --- Define all Time Variables to iterate over ---
time_vars_to_run <- c("cyclic_time", "cyclic_time_ov", "cyclic_time_impute", "cyclic_time_imp_ov")

# --- Table Formatting ---
table_cols_per_page <- 6

# --- Plot Layout ---
plots_per_col <- 3
plots_per_row <- 3 
```

#### 1.3: Automatic Setup & Data Load
```{r auto-setup-load}

# --- Create output folder with current date ---
current_date <- format(Sys.Date(), "%Y%m%d")
output_folder <- file.path(gam_output_base, paste0("GAM_Reports_", current_date))
dir.create(output_folder, showWarnings = FALSE, recursive = TRUE)

# --- Load Scaled Dataset ---

cycle_df_scaled <- get(load("~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/1_interim_datasets/adhd_daily_df_scaled_20250922.RData"))

# --- Robustness Check: Verify time variables exist ---
time_vars <- intersect(time_vars_to_run, names(cycle_df_scaled))
if (length(time_vars) < length(time_vars_to_run)) {
  missing_vars <- setdiff(time_vars_to_run, time_vars)
  warning("The following time_vars were not found and will be skipped: ", paste(missing_vars, collapse = ", "))
}
```

#### 1.4: Define Outcomes, Categories, and Custom Page Layouts
```{r outcomes-and-layouts}
# --- Define Outcomes to Model ---
outcomes <- c(
    "CSS_Inatt_Count" = "CSS Inattention Sx Count", "CSS_Hyp_Count" = "CSS Hyperactivity Sx Count",
    "CSS_Imp_Count" = "CSS Impulsivity Sx Count", "CSS_Inatt" = "CSS Inattention Sx Severity",
    "CSS_HypImp" = "CSS Hyperactivity/Impulsivity Sx Severity", "score_pinball" = "Working Memory Score (Pinball)",
    "score_robot" = "Response Inhibition (Robot Factory)", "BDEFS_WM_avg" = "Working Memory Sx (BDEFS)",
    "BDEFS_RI_avg" = "Response Inhibition Sx (BDEFS)", "DRSP_1" = "Depressed Mood", "DRSP_2" = "Hopelessness",
    "DRSP_3" = "Worthlessness/Guilt", "DRSP_4" = "Anxiety", "DRSP_5" = "Mood Swings",
    "DRSP_6" = "Rejection Sensitivity", "DRSP_7" = "Irritability", "DRSP_8" = "Interpersonal Conflicts",
    "DRSP_9" = "Less Interest in Activities", "DRSP_10" = "Difficulty Concentrating", "DRSP_11" = "Lethargy/Fatigue",
    "DRSP_12" = "Increased Appetite/Overate", "DRSP_13" = "Food Cravings", "DRSP_14" = "Hypersomnia",
    "DRSP_15" = "Insomnia", "DRSP_16" = "Overwhelmed/Couldn't Cope", "DRSP_17" = "Felt Out of Control",
    "DRSP_18" = "Breast Tenderness", "DRSP_19" = "Swelling/Bloating", "DRSP_20" = "Headache",
    "DRSP_21" = "Joint/Muscle Pain", "DRSP_22" = "Work Impairment", "DRSP_23" = "Relationship Impairment",
    "E2" = "Estradiol", "P4" = "Progesterone", "LH" = "Luteinizing Hormone"
)

# --- Define Categories for organization ---
outcome_categories <- tribble(
  ~category, ~variable,
  "ADHD Symptoms (CSS)", "CSS_Inatt_Count", "ADHD Symptoms (CSS)", "CSS_Hyp_Count",
  "ADHD Symptoms (CSS)", "CSS_Imp_Count", "ADHD Symptoms (CSS)", "CSS_Inatt", "ADHD Symptoms (CSS)", "CSS_HypImp",
  "Cognitive Score", "score_pinball", "Cognitive Score", "score_robot",
  "Executive Function (BDEFS)", "BDEFS_WM_avg", "Executive Function (BDEFS)", "BDEFS_RI_avg",
  "Hormone", "E2", "Hormone", "P4", "Hormone", "LH",
  "Mood & Physical (DRSP)", "DRSP_1", "Mood & Physical (DRSP)", "DRSP_2", "Mood & Physical (DRSP)", "DRSP_3",
  "Mood & Physical (DRSP)", "DRSP_4", "Mood & Physical (DRSP)", "DRSP_5", "Mood & Physical (DRSP)", "DRSP_6",
  "Mood & Physical (DRSP)", "DRSP_7", "Mood & Physical (DRSP)", "DRSP_8", "Mood & Physical (DRSP)", "DRSP_9",
  "Mood & Physical (DRSP)", "DRSP_10", "Mood & Physical (DRSP)", "DRSP_11", "Mood & Physical (DRSP)", "DRSP_12",
  "Mood & Physical (DRSP)", "DRSP_13", "Mood & Physical (DRSP)", "DRSP_14", "Mood & Physical (DRSP)", "DRSP_15",
  "Mood & Physical (DRSP)", "DRSP_16", "Mood & Physical (DRSP)", "DRSP_17", "Mood & Physical (DRSP)", "DRSP_18",
  "Mood & Physical (DRSP)", "DRSP_19", "Mood & Physical (DRSP)", "DRSP_20", "Mood & Physical (DRSP)", "DRSP_21",
  "Impairment (DRSP)", "DRSP_22", "Impairment (DRSP)", "DRSP_23"
) %>% right_join(enframe(outcomes, name = "variable", value = "outcome_label"), by = "variable")

# --- Define custom page layouts ---
page_definitions <- c(
  list(
    CSS_Page = outcome_categories %>% filter(category == "ADHD Symptoms (CSS)") %>% pull(outcome_label),
    Hormone_Page = outcome_categories %>% filter(category == "Hormone") %>% pull(outcome_label),
    Cog_EF_Page = c("Response Inhibition (Robot Factory)", "Response Inhibition Sx (BDEFS)", "Working Memory Score (Pinball)", "Working Memory Sx (BDEFS)")
  ),
  split(
    outcome_categories %>% filter(grepl("DRSP", category)) %>% pull(outcome_label),
    ceiling(seq_along(outcome_categories %>% filter(grepl("DRSP", category)) %>% pull(outcome_label)) / 9)
  )
)
names(page_definitions)[4:length(page_definitions)] <- paste0("DRSP_Page_", 1:(length(page_definitions)-3))


# --- Pre-calculate log-transformations ---
for (var in names(outcomes)) {
  if (var %in% names(cycle_df_scaled)) {
    log_var_name <- paste0(var, "_Log")
    cycle_df_scaled[[log_var_name]] <- log(cycle_df_scaled[[var]] + 1)
  }
}
```

---

### 2. Automated Reporting: Generate Comprehensive PDF for Each Participant

This section iterates through every participant, creating a PDF report with a styled summary table and plots of a consistent, fixed size.

```{r automated-reporting}
report_folder <- file.path(output_folder, "Participant_Reports_PDF")
dir.create(report_folder, showWarnings = FALSE, recursive = TRUE)
unique_ids <- unique(cycle_df_scaled$id)

for (current_id in unique_ids) {
  
  message(paste("--- Processing All Reports for ID:", current_id, "---"))
  datSX_id <- subset(cycle_df_scaled, id == current_id)
  
  for (current_time_var in time_vars) {
    
    message(paste("  --- Generating report for time variable:", current_time_var, "---"))
    
    # --- 1. MODELING STAGE: Run models for this ID and this TIME VARIABLE only ---
    all_predictions <- list()
    significance_results <- list()

    for (outcome_var in names(outcomes)) {
      log_outcome_var <- paste0(outcome_var, "_Log")
      if (!log_outcome_var %in% names(datSX_id)) next
      model_data <- datSX_id[complete.cases(datSX_id[, c(log_outcome_var, current_time_var)]), ]
      if (nrow(model_data) < 10 || var(model_data[[log_outcome_var]], na.rm = TRUE) < 1e-6) next
      tryCatch({
        adaptive_k <- min(10, nrow(model_data) - 1)
        if (adaptive_k < 3) next
        formula <- as.formula(paste(log_outcome_var, "~ s(", current_time_var, ", bs = 'cc', k = ", adaptive_k, ")"))
        knots <- list(c(-1, 1)); names(knots) <- current_time_var
        
        # üí° SOLUTION: Use bam() instead of gam() for much faster fitting on large data.
        # The 'discrete = TRUE' argument can provide an additional speed boost.
        model_fit <- mgcv::bam(formula, data = model_data, knots = knots, method = 'fREML', discrete = TRUE)
        
        p_value <- summary(model_fit)$s.pv[1]
        significance_results[[length(significance_results) + 1]] <- data.frame(variable = outcome_var, time_var = current_time_var, p.value = p_value)
        pred_grid <- expand.grid(time_points = seq(-1, 1, by = 0.05)); names(pred_grid)[1] <- current_time_var
        
        # Predictions are generated from the fitted model object, works the same for bam
        pred <- marginaleffects::predictions(model_fit, newdata = pred_grid, type = "response", transform = function(x) exp(x) - 1)
        
        pred$outcome_label <- outcomes[outcome_var]
        pred$p.value <- p_value
        pred$raw_range <- max(pred$estimate) - min(pred$estimate)
        
        all_predictions[[length(all_predictions) + 1]] <- pred
      }, error = function(e) {})
    }

    # --- 2. REPORT GENERATION STAGE (Unchanged from here down) ---
    if (length(all_predictions) == 0) { message(paste("    -> No successful models for this time variable. Skipping PDF.")); next }
    
    pdf_filename <- file.path(report_folder, paste0("Report_ID_", current_id, "_", current_time_var, ".pdf"))
    pdf(pdf_filename, width = 8.5, height = 11)

    summary_df <- dplyr::bind_rows(significance_results) %>%
      left_join(outcome_categories, by = "variable") %>%
      mutate(stars = case_when(p.value < 0.001 ~ "***", p.value < 0.01  ~ "**", p.value < 0.05  ~ "*", TRUE ~ "")) %>%
      select(Category = category, Outcome = outcome_label, Significance = stars) %>%
      arrange(Category)

    table_theme <- ttheme_default(base_size = 9, core = list(fg_params = list(hjust = 0, x = 0.05)), colhead = list(fg_params = list(hjust = 0, x = 0.05)))
    table_grob <- tableGrob(summary_df, rows = NULL, theme = table_theme)
    title_grob <- textGrob(paste("Significance of Cycle Effects for ID:", current_id), gp = gpar(fontsize = 16, fontface = "bold"))
    subtitle_grob <- textGrob(paste("Time Variable:", current_time_var), gp = gpar(fontsize = 12))
    footnote_grob <- textGrob("* p < 0.05, ** p < 0.01, *** p < 0.001", gp = gpar(fontsize = 9, fontface = "italic"), hjust = 1)
    grid.arrange(title_grob, subtitle_grob, table_grob, footnote_grob, ncol = 1, heights = unit(c(0.05, 0.05, 0.85, 0.05), "npc"))
    
    combined_plot_data <- dplyr::bind_rows(all_predictions)

    create_annotated_plot <- function(plot_df, menses_locs, ov_loc, axis_lbls) {
      if(nrow(plot_df) == 0) return(NULL)
      max_point <- slice_max(plot_df, order_by = estimate, n = 1, with_ties = FALSE)
      min_point <- slice_min(plot_df, order_by = estimate, n = 1, with_ties = FALSE)
      range_val <- first(plot_df$raw_range)
      p_val <- first(plot_df$p.value)
      stars <- case_when(p_val < 0.001 ~ "***", p_val < 0.01 ~ "**", p_val < 0.05 ~ "*", TRUE ~ "")
      annotation_text <- sprintf("%s Range = %.2f", stars, range_val)
      ggplot(plot_df, aes(x = .data[[current_time_var]], y = estimate)) +
          geom_vline(xintercept = menses_locs, color = "red") + geom_vline(xintercept = ov_loc, color = "forestgreen") +
          geom_line(linewidth = 1, color = "#0072B2") + geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "#0072B2", alpha = 0.2) +
          geom_point(data = max_point, color = "blue", size = 2.5) + geom_point(data = min_point, color = "purple", size = 2.5) +
          annotate("text", x = -1, y = Inf, label = annotation_text, hjust = -0.1, vjust = 1.5, size = 3, fontface = "bold") +
          labs(title = first(plot_df$outcome_label), x = "Cycle Phase", y = NULL) +
          scale_x_continuous(limits = c(-1, 1), breaks = seq(-1, 1, by = 0.5), labels = axis_lbls) +
          theme_minimal() +
          theme(plot.title = element_text(size=10, face="bold", hjust=0.5))
    }
    
    max_plots_per_page <- plots_per_col * plots_per_row
    
    if (grepl("ov", current_time_var)) {
      axis_labels <- c("Menses", "50%F", "Ovulation", "50%L", "Menses"); menses_intercepts <- c(-1, 1); ovulation_intercept <- 0
    } else {
      axis_labels <- c("Ovulation", "50%L", "Menses", "50%F", "Ovulation"); menses_intercepts <- 0; ovulation_intercept <- c(-1, 1)
    }

    for (page_name in names(page_definitions)) {
      page_outcomes <- page_definitions[[page_name]]
      page_data <- dplyr::filter(combined_plot_data, outcome_label %in% page_outcomes)
      if(nrow(page_data) == 0) next
      
      plot_list <- lapply(page_outcomes, function(outcome) {
        plot_df_single <- filter(page_data, outcome_label == outcome)
        create_annotated_plot(plot_df_single, menses_intercepts, ovulation_intercept, axis_labels)
      })
      plot_list <- Filter(Negate(is.null), plot_list)
      
      if (length(plot_list) > 0) {
        num_spacers <- max_plots_per_page - length(plot_list)
        if(num_spacers > 0) {
          for(i in 1:num_spacers) { plot_list[[length(plot_list) + 1]] <- plot_spacer() }
        }
        page_title <- paste("Symptom & Hormone Trajectories for ID:", current_id, "| Time Variable:", current_time_var)
        final_page <- wrap_plots(plot_list, ncol = plots_per_col) +
            plot_annotation(title = page_title, theme = theme(plot.title = element_text(size = 14, face = "bold")))
        print(final_page)
      }
    }
    
    dev.off()
    message(paste("    --- ‚úÖ Saved Report:", pdf_filename, "---"))
    
  } 
}
```
