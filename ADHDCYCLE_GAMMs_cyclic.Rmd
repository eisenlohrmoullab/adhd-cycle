---
title: "ADHDCYCLE_GAMMs_cyclic"
author: "Tory Eisenlohr-Moul, PhD"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```



# Loop Over and Save all GAMMs and Model-Implied Plots - Cyclic Time (No Imputation) and Log Transformation of all Outcomes

```{r}
# --- 1. Setup ---

# Assume 'cycle_df_scaled' is your pre-existing dataframe

# Define your output folder and current date
gamm_output_folder <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/GAMMs/"
current_date <- format(Sys.Date(), "%Y%m%d")
```


```{r}
# --- 2. Define Outcomes and Labels ---
# Create a named vector. The 'names' are the column names in your dataframe.
# The 'values' are the pretty labels you want on your plots.
outcomes <- c(
  "CSS_Inatt_Count" = "CSS Inattention Sx Count",
  "CSS_Hyp_Count" = "CSS Hyperactivity Sx Count", 
  "CSS_Imp_Count" = "CSS Impulsivity Sx Count", 
    "score_pinball" = "Working Memory Score (Pinball)", 
    "score_robot" = "Reponse Inhibition (Robot Factory)", 
    "BDEFS_WM_avg" = "Working Memory Sx (BDEFS)", 
    "BDEFS_RI_avg" = "Response Inhibition Sx (BDEFS)", 
    "DRSP_1" = "Depressed Mood", 
    "DRSP_4" = "Anxiety", 
    "DRSP_7" = "Irritability")


# Get the actual column names from the dataframe
actual_colnames <- names(cycle_df_scaled)

# Loop through your defined outcomes and check if they exist
for (outcome_to_check in names(outcomes)) {
  if (outcome_to_check %in% actual_colnames) {
    message(paste("✅ Found:", outcome_to_check))
  } else {
    message(paste("❌ NOT FOUND:", outcome_to_check))
  }
}
```


```{r}
# --- 1. Setup ---

# Define the time variable you want to use
# You can easily switch this back to "cyclic_time" if needed
time_var <- "cyclic_time_ov"

# Define your output folder and current date
gamm_output_folder <- "~/Library/CloudStorage/Box-Box/00 - CLEAR Lab (Locked Folders)/02 - Data Management, Analysis, and Papers/Studies_Projects/CYCLEADHD/03_analytic_projects/CYCADHD_PRIMARY/03_code_dataedits_output/GAMMs/"
current_date <- format(Sys.Date(), "%Y%m%d")
```


```{r}
# --- 2. Define Outcomes and Labels ---
outcomes <- c("E2" = "Estradiol",
              "P4" = "Progesterone", 
              "LH" = "Luteinizing Hormone",
  "CSS_Inatt_Count" = "CSS Inattention Sx Count",
  "CSS_Hyp_Count" = "CSS Hyperactivity Sx Count",
  "CSS_Imp_Count" = "CSS Impulsivity Sx Count",
  "score_pinball" = "Working Memory Score (Pinball)",
  "score_robot" = "Reponse Inhibition (Robot Factory)",
  "BDEFS_WM_avg" = "Working Memory Sx (BDEFS)",
  "BDEFS_RI_avg" = "Response Inhibition Sx (BDEFS)",
  "DRSP_1" = "Depressed Mood",
  "DRSP_4" = "Anxiety",
  "DRSP_7" = "Irritability")

```


```{r}
# --- 3. Loop Through Each Outcome ---
for (outcome_var in names(outcomes)) {

  outcome_label <- outcomes[outcome_var]
  log_outcome_var <- paste0(outcome_var, "_Log")

  message(paste("Processing outcome:", outcome_label, "with time variable:", time_var))

  # Log-transform the current outcome variable
  cycle_df_scaled[[log_outcome_var]] <- log(cycle_df_scaled[[outcome_var]] + 1)

  # Prepare data for the model using the specified time_var
  selected_vars <- c(time_var, log_outcome_var, "id")
  datSX <- cycle_df_scaled[complete.cases(cycle_df_scaled[selected_vars]), ]
  datSX$id <- as.factor(datSX$id)

  # Dynamically create the formula for the GAM model using time_var
  gamm_formula <- as.formula(paste(
    log_outcome_var,
    "~ s(", time_var, ", bs = 'cc', k = 10) + s(id, bs = 're') + s(id,", time_var, ", bs = c('re','cc'), k = c(NA, 10))"
  ))
  
  # Create the knots list dynamically
  knots_list <- list(c(-1, 1))
  names(knots_list) <- time_var

  # Run the GAMM model
  gamm <- mgcv::gam(
    formula = gamm_formula,
    data = datSX,
    knots = knots_list,
    method = 'REML'
  )

  # Save the model summary to a dynamically named .txt file
  summary_filename <- paste0(gamm_output_folder, "gamm_", log_outcome_var, "_", time_var, "_summary_", current_date, ".txt")
  sink(summary_filename)
  print(summary(gamm))
  sink()

  # --- Plotting ---
  
  # Create a named list for expand.grid using the time_var string
  grid_list <- list(seq(-1, 1, by = 0.05), id = 0)
  names(grid_list)[1] <- time_var
  plotdat <- do.call(expand.grid, grid_list)

  # Get predictions and back-transform them
  pred <- marginaleffects::predictions(
    gamm,
    newdata = plotdat,
    type = "response",
    transform = function(x) exp(x) - 1
  )

  plotdat$estimate <- pred$estimate
  plotdat$conf.low <- pred$conf.low
  plotdat$conf.high <- pred$conf.high

  # Generate the plot with the dynamic y-axis label
  gamplot <- ggplot(plotdat, aes(x = .data[[time_var]], y = estimate)) +
    scale_x_continuous(
      limits = c(-1, 1),
      breaks = seq(-1, 1, by = 0.50),
      # IMPORTANT: You may need to change these labels to match the meaning of cyclic_time_ov
      labels = c("Menses Onset", "50%F", "Ovulation", "50%L", "Menses Onset")
    ) +
    labs(x = "", y = outcome_label) +
    geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf, fill = "grey70", alpha = 0.2, color = "white") +
    geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf, fill = "grey87", alpha = 0.2, color = "white") +
    geom_line(linewidth = 1) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "lightgrey", alpha = 0.3) +
    theme_minimal()

  print(gamplot)

  # Save the plot to a dynamically named .png file
  plot_filename <- paste0(gamm_output_folder, "gamplot_", log_outcome_var, "_", time_var, "_", current_date, ".png")
  ggsave(plot_filename, gamplot, width = 8, height = 6, dpi = 300)

}
```

# Plot E2, P4, and LH across cyclic_time_ov
```{r}

hormone_vars <- c("E2" = "Estradiol",
                   "P4" = "Progesterone", 
                   "LH" = "Luteinizing Hormone")

for (hormone_var in names(hormone_vars)) {
  hormone_label <- hormone_vars[hormone_var]
  
  message(paste("Processing hormone:", hormone_label, "with time variable:", time_var))
  
  # Prepare data for the model using the specified time_var
  selected_vars <- c(time_var, hormone_var, "id")
  datSX <- cycle_df_scaled[complete.cases(cycle_df_scaled[selected_vars]), ]
  datSX$id <- as.factor(datSX$id)
  
  # Dynamically create the formula for the GAM model using time_var
  gamm_formula <- as.formula(paste(
    hormone_var,
    "~ s(", time_var, ", bs = 'cc', k = 10) + s(id, bs = 're') + s(id,", time_var, ", bs = c('re','cc'), k = c(NA, 10))"
  ))
  
  # Create the knots list dynamically
  knots_list <- list(c(-1, 1))
  names(knots_list) <- time_var
  
  # Run the GAMM model
  gamm <- mgcv::gam(
    formula = gamm_formula,
    data = datSX,
    knots = knots_list,
    method = 'REML'
  )
  
  # Save the model summary to a dynamically named .txt file
  summary_filename <- paste0(gamm_output_folder, "gamm_", hormone_var, "_", time_var, "_summary_", current_date, ".txt")
  sink(summary_filename)
  print(summary(gamm))
  sink()
  
  # --- Plotting ---
  
  # Create a named list for expand.grid using the time_var string
  grid_list <- list(seq(-1, 1, by = 0.05), id = 0)
  names(grid_list)[1] <- time_var
  plotdat <- do.call(expand.grid, grid_list)
  
  # Get predictions
  pred <- marginaleffects::predictions(
    gamm,
    newdata = plotdat,
    type = "response"
  )
  
  plotdat$estimate <- pred$estimate
  plotdat$conf.low <- pred$conf.low
  plotdat$conf.high <- pred$conf.high
  
  # Generate the plot with the dynamic y-axis label
  gamplot <- ggplot(plotdat, aes(x = .data[[time_var]], y = estimate)) +
    scale_x_continuous(
      limits = c(-1, 1),
      breaks = seq(-1, 1, by = 0.50),
      # IMPORTANT: You may need to change these labels to match the meaning of cyclic_time_ov
      labels = c("Menses Onset", "50%F", "Ovulation", "50%L", "Menses Onset")
    ) +
    labs(x = "", y = hormone_label) +
    geom_rect(xmin = -0.04, xmax = 0.04, ymin = -Inf, ymax = Inf, fill = "grey70", alpha = 0.2, color = "white") +
    geom_rect(xmin = 0.92, xmax = 1, ymin = -Inf, ymax = Inf, fill = "grey87", alpha = 0.2, color = "white") +
    geom_line(linewidth = 1) +
    geom_ribbon(aes(ymin = conf.low, ymax = conf.high), fill = "lightgrey", alpha = 0.3) +
    theme_minimal()
  print(gamplot)
  # Save the plot to a dynamically named .png file
  plot_filename <- paste0(gamm_output_folder, "gamplot_", hormone_var, "_", time_var, "_", current_date, ".png")
  ggsave(plot_filename, gamplot, width = 8, height = 6, dpi = 300)
}

```


```{r}

library(menstrualcycleR)

cycle_plot(
  df_scaled,
  symptom = "E2",
  centering = "ovulation",
  include_impute = FALSE,
  y_scale = "person-centered_roll",
  rollingavg = 5,
  align_val = "center",
  se = T
)


cycle_plot(
  df_scaled,
  symptom = "P4",
  centering = "ovulation",
  include_impute = FALSE,
  y_scale = "person-centered_roll",
  rollingavg = 5,
  align_val = "center",
  se = T
)


cycle_plot(
  df_scaled,
  symptom = "LH",
  centering = "ovulation",
  include_impute = FALSE,
  y_scale = "person-centered_roll",
  rollingavg = 5,
  align_val = "center",
  se = T
)

```


